---
title: "VISION 2050 and MSA Growth Comparisons"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(odbc)
library(DBI)
library(data.table)
library(ggplot2)
library(scales)
library(knitr)
library(lubridate)
library(plotly)
library(leaflet)
library(sp)
library(rgdal)
library(rgeos)
library(DT)

base_year <- 2017
area_type <- "statistical area"
pop_threshold <- 1000000

# Vision 2050 Scenario Results
pop_2050 <- 5823165
hours_2050 <- 12735000
tfg_boardings <- 521253000
lrt_focus_boardings <- 573129000
dispersed_boardings <- 468745000

bar_colors <- c(
    "0" = "#76787A",
    "1" = "#F05A28",
    "2" = "#8CC63E",
    "3" = "#00A7A0")

# SQL Database Connection settings
elmer_connection <- dbConnect(odbc::odbc(),
  driver = "SQL Server",
  server = "sql2016\\DSADEV",
  database = "Sandbox",
  trusted_connection = "yes"
  )

create_bar_charts <- function(current_tbl, current_metric) {
  wrk_tbl <- current_tbl[variable %in% current_metric]
  ylimit <- max(wrk_tbl$value)
  setorder(wrk_tbl,value,value)

  labels <- paste0("<b>","Metro Area: ", "</b>",wrk_tbl$name,
                 "<b> <br>",paste0(current_metric,": "), "</b>",prettyNum(round(wrk_tbl$value, 0), big.mark = ",")) %>% lapply(htmltools::HTML)

  wrk_chart <- ggplot(wrk_tbl, aes(x = reorder(name,value), y= value, fill = as.factor(plot_id),text=labels)) + 
  geom_bar(stat = "identity") +
  theme_void() +
  scale_y_continuous(labels = comma)+
  scale_fill_manual(values=bar_colors)+
  theme(legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_blank())

  wrk_chart <- ggplotly(wrk_chart, tooltip = c("text"))
  return(wrk_chart)
}

# Urban Area and UZA lookup file
to_open <- paste0(getwd(),"/inputs/uza_ua_codes.csv")
msa <- read.csv(to_open)
setDT(msa)
setnames(msa,c("ua_id","uza_id","uza_name","msa_id","msa_name"))
uza_msa <- msa[,c("uza_id","msa_id")]

# Table Name from the Central Database
ntd_data <- "Craig.ntd_monthly_transit_data"
msa_data <- "Craig.national_msa_population"
fips_codes <- "Craig.fips_codes"

# Load the Tables from the database and then close the connection
transit <- dbReadTable(elmer_connection,SQL(ntd_data))
population <- dbReadTable(elmer_connection,SQL(msa_data))
fips <- dbReadTable(elmer_connection,SQL(fips_codes))

odbc::dbDisconnect(elmer_connection)

# Ensure all are of data.table types
setDT(transit)
setDT(population)
setDT(fips)

# Calculate Boardings and Hours by Urban Area to join with MSA Population via the Urban Area to MSA IDs

urban_areas <- NULL
transit_variables <- c("UPT","VRH")

for (vars in transit_variables) {
  wrk_tbl <- transit[attribute %in% vars]

  # Get Base Year Data and remove Demand Response data
  wrk_tbl <- wrk_tbl[year(date) %in% base_year]
  wrk_tbl <- wrk_tbl[modes != "DR" | modes != "DT"]
  wrk_tbl[is.na(wrk_tbl)] <- 0
  col_keep <- c("uza_code","value")
  wrk_tbl <- wrk_tbl[,..col_keep]
  nms <- c("uza_id",vars)
  setnames(wrk_tbl,nms)

  # Aggregate UZA and join with UZA/MSA table
  wrk_uza <- aggregate(wrk_tbl, by=list(wrk_tbl$uza_id),FUN=sum)
  setDT(wrk_uza)
  nms <- c("uza_id","uza_2",vars)
  setnames(wrk_uza,nms)
  fcols <- c("uza_id",vars)
  wrk_uza <- wrk_uza[,..fcols]
  
  if (is.null(urban_areas)) {urban_areas <- wrk_uza} else {urban_areas <- merge(urban_areas, wrk_uza, by = "uza_id")}

}

# Add MSA ID to Transit Table based on UZA to MSA Lookup and aggregate
urban_areas <- merge(urban_areas, uza_msa, by = "uza_id")
fcols <- c("msa_id",transit_variables)
urban_areas <- urban_areas[,..fcols]
msa_results <- aggregate(urban_areas, by=list(urban_areas$msa_id),FUN=sum)
setDT(msa_results)
nms <- c("msa_id","msa_2",transit_variables)
setnames(msa_results,nms)
fcols <- c("msa_id",transit_variables)
msa_results <- msa_results[,..fcols]

# Connect MSA Results with MSA Names
fips <- fips[category %in% area_type]
fips <- fips[,c("geoid","name")]
fips <- fips[,geoid:=as.integer(geoid)]
msa_results <- merge(msa_results, fips, by.x = "msa_id",by.y="geoid")

# Connect Base Year Population to the Summary Results
population <- population[year %in% base_year]
population <- population[,geoid:=as.integer(geoid)]
fcols <- c("geoid","value")
population <- population[,..fcols]
nms <- c("geoid","population")
setnames(population,nms)
msa_results <- merge(msa_results, population, by.x = "msa_id",by.y="geoid")

# Combine Seattle and Bremerton
msa_results$msa_id[msa_results$msa_id == 14740] <- 42660

# Create an updated summary
fcols <- c("msa_id","population",transit_variables)
interim <- msa_results[,..fcols] 
msa_comparison <- aggregate(interim, by=list(msa_results$msa_id),FUN=sum)
cnames <- c("msa_id","msa_2","Population","Boardings","Service_Hours")
setnames(msa_comparison,cnames)
msa_comparison <- msa_comparison[,c("msa_id","Population","Boardings","Service_Hours")] 
msa_comparison <- merge(msa_comparison, fips, by.x = "msa_id", by.y = "geoid")
msa_comparison$Boardings_per_Capita <- msa_comparison$Boardings / msa_comparison$Population
msa_comparison$Boardings_per_Hour <- msa_comparison$Boardings / msa_comparison$Service_Hours
setDT(msa_comparison)

# Trim dwon the comparison to places with more than 1m people in the Base Year
msa_comparison <- msa_comparison[Population >= pop_threshold]

# Create Puget Sound Region for 2050 and join to Urban Area Comparison
tfg_2050 <- as.data.table(list(msa_id=99998, Population=pop_2050, Boardings=lrt_focus_boardings, Service_Hours=hours_2050, name="Puget Sound Region 2050 - Transit Focus",Boardings_per_Capita=lrt_focus_boardings/pop_2050,Boardings_per_Hour=lrt_focus_boardings/hours_2050))

#rug_2050 <- as.data.table(list(msa_id=99999, Population=pop_2050, Boardings=dispersed_boardings, Service_Hours=hours_2050, name="Puget Sound Region 2050 - Dispersed Growth",Boardings_per_Capita=dispersed_boardings/pop_2050,Boardings_per_Hour=dispersed_boardings/hours_2050))

msa_comparison <- rbind(msa_comparison,tfg_2050)
msa_comparison$plot_id <- 0
msa_comparison$plot_id[msa_comparison$msa_id == 42660] <- 1
msa_comparison$plot_id[msa_comparison$msa_id == 99998] <- 2
msa_comparison$plot_id[msa_comparison$msa_id == 99999] <- 3

# Flatten Urban Area Table
msa_tbl <- melt(msa_comparison, id.vars=c('msa_id','name',"plot_id"))
pop_chart <- create_bar_charts(msa_tbl,"Population")
boardings_chart <- create_bar_charts(msa_tbl,"Boardings")
boardings_per_capita_chart <- create_bar_charts(msa_tbl,"Boardings_per_Capita")
boardings_per_hour_chart <- create_bar_charts(msa_tbl,"Boardings_per_Hour")

```

## Population by Metropolitan Regions
Forecasts of population growth by 2050 put the Puget Sound Region over 5.8 million people.

```{r plot_pop_charts, echo = FALSE}
pop_chart
```

## Boardings by Metropolitan Regions
Forecasts of transit growth by 2050 put the Puget Sound Region over 500 million annual boardings.

```{r plot_boardings_charts, echo = FALSE}
boardings_chart
```

## Boardings per Capita by Metropolitan Regions
Forecasts of transit use per capita by 2050 put the Puget Sound Region in the top three.

```{r plot_boardings_per_capita_charts, echo = FALSE}
boardings_per_capita_chart
```

## Boardings per Revenue Hour by Metropolitan Regions
Forecasts of transit use per revenue hour by 2050 put the Puget Sound Region in the top three.

```{r plot_boardings_per_hour_charts, echo = FALSE}
boardings_per_hour_chart
```