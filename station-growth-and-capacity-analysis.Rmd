---
title: "VISION 2050 Scenario Comparisons"
output: 
  html_document:
    theme: cerulean
    toc: true
    toc_float: true
    number_sections: false
---
```{r general_setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(purrr)
library(ggplot2)
library(data.table)
library(scales)
library(plotly)
library(DT)
library(leaflet)
library(sp)
library(rgdal)
library(readxl)
library(foreign)

# Flag to determine if new lookups should be created
new_geo_lookup <- "no"

# Flag to determine Network or Linear Buffer
network_buffer <-"yes"

# Regional Population and Employment from the Regional Macroforecast 
pop_2017 <- 4066800
hh_pop_2017 <- 3986995
hh_2017 <- 1587176
jobs_2017 <- 2250546

pop_2050 <- 5823165
hh_pop_2050 <- 5720596
hh_2050 <- 2419949
jobs_2050 <- 3391293

ntd_boardings_2014 <- 209000000
annualization <- 320

analysis_years <- c(2017,2050)

# Indicator File Directories
tfg <- "tfg"
serpentor <- "serpentor"
destro <- "destro"
lift_ticket <- "liftticket"

# Parcel Capacity File
cap_file <- "parcel_level_capacity"

# Travel Model Outputs
soundcast <- "soundcast_screening_factors"


# Geogrpahic Lookups by parcel
all_transit_file  <- "all_transit"
county_file  <- "county"
minority_file <- "minority"
city_file  <- "city"
poverty_file <- "poverty"
lrt_stations <- "lrt_stations"

if (network_buffer == "yes") {tod_file<-"tod_network"} else {tod_file<-"tod_linear"}

# Capacity Column Names
hh_cap_col <- "DUdiff50"
job_cap_col <- "JOBSPdiff50"

# Lists for Analysis
alternatives <- list(c(tfg, "TFG", "Transit Focused"), c(lift_ticket, "LRT", "Light Rail Focused"),c(destro, "DUG", "35/35 Dispersed") )
scen_levls <- c(alternatives[[1]][[3]],alternatives[[2]][[3]],alternatives[[3]][[3]])

cap_atttributes <- list("pop_capacity","job_capacity")
lu_atttributes <- list("population","employment")
cap_atttributes <- list("pop_capacity","job_capacity")

# TOD Types with a consistent definition amongst network buffer types
tod_types <- list(100,101,102,103,104,105,106,100:106)
tod_names <- c("Non-HCT","Light Rail","Commuter Rail","Ferry","Bus Rapid Transit","Regional Growth Centers","Local Transit","Region Total")

sum_table_values <- function(tbl, w_scen, w_var, w_tod, w_yr) {
  
  wrk_tot <- as.integer(tbl[scenario %in% w_scen & variable %in%  w_var & tod_id %in% w_tod & year %in% w_yr,sum(value)])
  return(wrk_tot)
}

create_table_container <- function(cat_nms, scen_nms, metric_nms) {

  wrk_container = htmltools::withTags(table(
    class = 'display',
    thead(
      tr(
        th(class = 'dt-center', rowspan = 3, cat_nms)
      ),
      tr(
        lapply(scen_nms, function(x) th(class = 'dt-center', colspan =2, x))
      ),
          tr(
        lapply(rep(metric_nms, length(scen_nms)), function(x) th(class = 'dt-center', x))
      )
    )
  ))

return(wrk_container)

}

create_geo_lookup <- function(fname, ftype, wrk_cols ,id_nm) {

  to_open <- paste0(getwd(),"/inputs/",fname,ftype)
  
  if (ftype == ".tab") {wrk_tbl <- read.table(to_open, sep = '\t',header = TRUE)} 
  
  else if (ftype == ".dbf") {wrk_tbl <- read.dbf(to_open)} 
  
  else  {wrk_tbl <- read.csv(to_open)}
  
  setnames(wrk_tbl, tolower(names(wrk_tbl)))
  wrk_tbl <- wrk_tbl[,wrk_cols]
  fwrite(wrk_tbl, paste0(getwd(),"/inputs/",id_nm,".csv"))

}

create_station_area_tables <- function(tbl, alt_list,current_variable, tbl_view_len) {

  short_names <- NULL
  for (files in alt_list) {
    short_names <- c(short_names, files[[2]])
    }

  scenario_names <- NULL
  for (files in alt_list) {
    scenario_names <- c(scenario_names, files[[3]])
    }

  # Create Variable Specific Table by Scenario
  wrk_summary <- tbl[variable %in% current_variable]
  wrk_summary[,variable:=NULL]

  s_tbl <- dcast(wrk_summary, station_name ~ scenario, value.var="results")
  setcolorder(s_tbl,c("station_name",short_names))

  clean_tbl <- datatable(s_tbl, rownames = FALSE, options = list(pageLength = tbl_view_len), colnames = c('Station Area', scenario_names))

  for (working_column in short_names) {
    clean_tbl <- clean_tbl %>% 
      formatCurrency(working_column, "", digits = 0) %>%
      formatStyle(working_column,`text-align` = 'center')
  }

  return(clean_tbl)
}

create_table_from_input <- function(fdir,fname,ftype) {
  w_fname <- paste0(getwd(),"/",fdir,"/",fname,".",ftype)
  
  if (ftype == "tab") {wtbl <- read.table(w_fname, sep = '\t',header = TRUE)} 
  
  else if (ftype == "dbf") {wtbl <- read.dbf(w_fname)} 
  
  else  {wtbl <- read.csv(w_fname)}
  
  setDT(wtbl)
  return(wtbl)
}

region_pop_growth <-  pop_2050 - pop_2017
region_job_growth <-  jobs_2050 - jobs_2017
hh_size <- hh_pop_2050 / hh_2050

# Create new parcel to geogrpahy lookups if necessary
if (new_geo_lookup == "yes") {
  create_geo_lookup(cap_file,".csv",c("parcel_id","tod_id"),"tod_linear")
  create_geo_lookup(cap_file,".csv",c("parcel_id","city_id"),"city")
  create_geo_lookup(transit,".csv",c("parcel_id","transit_buffer_id"),"all_transit")
  create_geo_lookup(ppa65,".tab",c("parcel_id","county_id"),"county")
  create_geo_lookup(ppa65,".tab",c("parcel_id","minority_id"),"minority")
  create_geo_lookup(ppa65,".tab",c("parcel_id","poverty_id"),"poverty")
  create_geo_lookup(tod_file,".dbf",c("parcel_id","tod_id"),"tod_network")
}  

```

```{r tod_flag_setup, include=FALSE}

# Create a data.table of parcel id's with the TOD area looukps
tod_lookup <- create_table_from_input("inputs",tod_file,"csv")
all_transit_lookup <- create_table_from_input("inputs",all_transit_file,"csv")

# Recode the TOD ID's for consistency between the Linear and Network Buffers
if (network_buffer == "yes") {
  tod_lookup$tod_id[tod_lookup$tod_id == 0 ] <- 100
  tod_lookup$tod_id[tod_lookup$tod_id == 4 ] <- 101
  tod_lookup$tod_id[tod_lookup$tod_id == 2 ] <- 102
  tod_lookup$tod_id[tod_lookup$tod_id == 5 ] <- 103
  tod_lookup$tod_id[tod_lookup$tod_id == 1 ] <- 104
  tod_lookup$tod_id[tod_lookup$tod_id == 6 ] <- 105
  
} else {
  tod_lookup$tod_id[tod_lookup$tod_id == 0 ] <- 100
  tod_lookup$tod_id[tod_lookup$tod_id == 1 | tod_lookup$tod_id == 2 ] <- 101
  tod_lookup$tod_id[tod_lookup$tod_id == 3 | tod_lookup$tod_id == 4 ] <- 102
  tod_lookup$tod_id[tod_lookup$tod_id == 5 | tod_lookup$tod_id == 6] <- 103
  tod_lookup$tod_id[tod_lookup$tod_id == 7 | tod_lookup$tod_id == 8 ] <- 104
  tod_lookup$tod_id[tod_lookup$tod_id == 9 ] <- 105
}
  
# Merge the TOD areas and All Transit to add the Local Transit Flag to the TOD ID's (item 10)
parcels_geo <- merge(tod_lookup, all_transit_lookup, by = "parcel_id")
  
# Update TOD Flag to capture Local Transit
parcels_geo$tod_id[parcels_geo$tod_id == 100 & parcels_geo$transit_buffer_id == 1] <- 106
parcels_geo <- parcels_geo[,transit_buffer_id:=NULL]

```

```{r capacity_calualtions, include=FALSE}

# Clear out temporary data.tables
wrk_parcels <- NULL
w_tbl <- NULL

w_tbl <- create_table_from_input("inputs",cap_file,"csv")
cols <- c("parcel_id",hh_cap_col,job_cap_col)
w_tbl <-w_tbl[,..cols]
upd_nms <- c("parcel_id","hh_capacity","job_capacity")
setnames(w_tbl,upd_nms)
w_tbl <- w_tbl[,(upd_nms):= lapply(.SD, as.integer), .SDcols = upd_nms]

# Convert HH Capacity to Population Capacity using the Regional Average Household Size
w_tbl$pop_capacity <- as.integer(w_tbl$hh_capacity * hh_size)
w_tbl <- w_tbl[,hh_capacity:=NULL]

# Join the capacity and TOD Flags
wrk_parcels <- merge(parcels_geo, w_tbl, by = "parcel_id")
wrk_parcels <- melt(wrk_parcels,id.vars = c("parcel_id","tod_id"), measure.vars = c("pop_capacity","job_capacity"))
wrk_parcels$scenario <- "all_scenarios"
wrk_parcels$year <- analysis_years[[1]]

# Store the capacity results in the final list
results_by_type = NULL

for (wrk_att in cap_atttributes) {

  calc_by_tod <- partial(sum_table_values, tbl=wrk_parcels, w_scen="all_scenarios", w_var=wrk_att, w_yr=analysis_years[[1]])
  results_by_type[[paste0("all_scenarios_",wrk_att)]] <- map(tod_types,calc_by_tod)
  
}

parcel_capacity <- wrk_parcels
```

```{r scenario_calualtions, include=FALSE}

# Values for melted parcels
wrk_measures <- c("population","employment")
wrk_vars <- c("parcel_id","tod_id")
  
# Clear out temporary data.tables
wrk_parcels <- NULL
w_tbl <- NULL
parcels <- NULL

for (files in alternatives) {

  # Read in Scenario Specific Population and Employment Data by Year
  
  for (w_years in analysis_years) {
  
    w_tbl <- create_table_from_input(paste0("inputs/",files[[1]]),paste0("parcel__dataset_table__households_jobs__",w_years),"tab")
    cols <- c("parcel_id",wrk_measures)
    w_tbl <- w_tbl[,..cols]
    w_tbl <- w_tbl[,(cols):= lapply(.SD, as.integer), .SDcols = cols]

   # Join with TOD Flags
    wrk_parcels <- merge(parcels_geo, w_tbl, by = "parcel_id")
    wrk_parcels <- melt(wrk_parcels, id.vars = wrk_vars, measure.vars = wrk_measures)
    wrk_parcels$scenario <- files[[2]]
    wrk_parcels$year <- w_years
  
    if (is.null(parcels)) {parcels <- wrk_parcels} else {parcels <- rbind(parcels,wrk_parcels)}
  }
}

# Calculate the Total Population and Employment by Scenario and Year and place in a named list
for (files in alternatives) {
  for (lu in lu_atttributes) {
    for (w_year in analysis_years) {
    calc_by_tod <- partial(sum_table_values, tbl=parcels, w_scen=files[[2]], w_var=lu, w_yr=w_year)
    results_by_type[[paste0(files[[2]],"_",w_year,"_",lu)]] <- map(tod_types,calc_by_tod)
    }
  }
}

# Calculate various differences from the base year
for (files in alternatives) {
  # Calculate the Total Change from the Base Year
  results_by_type[[paste0(files[[2]],"_pop_change")]] <- Map('-',  results_by_type[[paste0(files[[2]],"_",analysis_years[[2]],"_", wrk_measures[[1]])]], results_by_type[[paste0(files[[2]],"_",analysis_years[[1]],"_", wrk_measures[[1]])]])
  
  results_by_type[[paste0(files[[2]],"_job_change")]] <- Map('-',  results_by_type[[paste0(files[[2]],"_",analysis_years[[2]],"_", wrk_measures[[2]])]], results_by_type[[paste0(files[[2]],"_",analysis_years[[1]],"_", wrk_measures[[2]])]])
 
  # Calculate the Share of the Total Change from the Base Year
  total_hh_pop_chg <- sum(unlist(results_by_type[[paste0(files[[2]],"_pop_change")]])[c(1:7)])
  total_job_chg <- sum(unlist(results_by_type[[paste0(files[[2]],"_job_change")]])[c(1:7)])
  results_by_type[[paste0(files[[2]],"_share_pop_change")]] <- Map('/',  results_by_type[[paste0(files[[2]],"_pop_change")]], total_hh_pop_chg)
  results_by_type[[paste0(files[[2]],"_share_job_change")]] <- Map('/',  results_by_type[[paste0(files[[2]],"_job_change")]], total_job_chg)  
  
  # Calculate the Remaining Capacity
  results_by_type[[paste0(files[[2]],"_remain_pop_cap")]] <- Map('-',  results_by_type[["all_scenarios_pop_capacity"]], results_by_type[[paste0(files[[2]],"_pop_change")]])
  results_by_type[[paste0(files[[2]],"_remain_job_cap")]] <- Map('-',  results_by_type[["all_scenarios_job_capacity"]], results_by_type[[paste0(files[[2]],"_job_change")]])

  # Calculate the Share of remaining Capacity
  results_by_type[[paste0(files[[2]],"_percent_pop_cap")]] <- Map('/',  results_by_type[[paste0(files[[2]],"_pop_change")]], results_by_type[["all_scenarios_pop_capacity"]])
  results_by_type[[paste0(files[[2]],"_percent_job_cap")]] <- Map('/',  results_by_type[[paste0(files[[2]],"_job_change")]], results_by_type[["all_scenarios_job_capacity"]])    
}

```

```{r lrt_stations_setup, include=FALSE}

# Values for melted parcels
wrk_measures <- c("population","employment")
wrk_vars <- c("parcel_id","station_name")
  
# Clear out temporary data.tables
wrk_parcels <- NULL
w_tbl <- NULL
parcels <- NULL

# Create a data.table of parcel id's with the LRT Station Area Names
lrt_station_lookup <- create_table_from_input("inputs",lrt_stations,"csv")

for (files in alternatives) {
  
  for (w_years in analysis_years) {

  # Read in Scenario Specific Popualtion and Employment Data
  w_tbl <- create_table_from_input(paste0("inputs/",files[[1]]),paste0("parcel__dataset_table__households_jobs__",w_years),"tab")
  
  cols <- c("parcel_id",wrk_measures)
  w_tbl <- w_tbl[,..cols]
  w_tbl <- w_tbl[,(cols):= lapply(.SD, as.integer), .SDcols = cols]
  
  # Join with Station Area Names
  wrk_parcels <- merge(w_tbl, lrt_station_lookup, by = "parcel_id")
  wrk_parcels <- melt(wrk_parcels, id.vars = wrk_vars, measure.vars = wrk_measures)
  wrk_parcels$scenario <- files[[2]]
  wrk_parcels$year <- w_years
  
  # Join with Capacity
  wrk_capacity <- merge(parcel_capacity, lrt_station_lookup, by = "parcel_id")
  wrk_capacity$scenario <- files[[2]]
  wrk_capacity[,tod_id:=NULL]
  wrk_parcels <- rbind(wrk_parcels,wrk_capacity)
  
  if (is.null(parcels)) {parcels <- wrk_parcels} else {parcels <- rbind(parcels,wrk_parcels)}
  }

}

station_summary <- parcels[,.(results = sum(value)),by=.(station_name,variable,scenario,year)]
station_summary <- station_summary[station_name != ""]

# Calculate the Population and Employment Growth from the Base Year by Scenario
for (files in alternatives) {
  
  base_att <- NULL
  scen_att <- NULL
  scen_delta <- NULL

  for (lu_att in lu_atttributes) {
    wrk_scen <- files[[2]]
    
    # Get Base Year Values by Station Area
    base_att <- station_summary[variable %in% lu_att & scenario %in% wrk_scen & year %in% analysis_years[[1]]]
    base_att <- base_att[,c("station_name","results")]
    setnames(base_att,c("station_name","base_year"))  

    # Get Scenario Values by Station Area
    scen_att <- station_summary[variable %in% lu_att & scenario %in% wrk_scen & year %in% analysis_years[[2]]]
    scen_att <- scen_att[,c("station_name","results")]
    setnames(scen_att,c("station_name","future_year"))

    # Merge and Calculate the difference
    scen_delta <- merge(base_att, scen_att, by = "station_name")
    scen_delta$results <- scen_delta$future_year - scen_delta$base_year
    scen_delta$variable <- paste0(lu_att,"_growth")
    scen_delta$scenario <- wrk_scen
    scen_delta$year <- analysis_years[[2]]
    scen_delta <- scen_delta[,c("station_name","variable","scenario","results","year")]

    station_summary <- rbind(station_summary,scen_delta)
  }
}  

# Calculate the Population and Employment Capacity Remaining by Scenario
for (files in alternatives) {
  
  base_att <- NULL
  scen_att <- NULL
  scen_delta <- NULL
  grw_att <- NULL

  for (cap_att in cap_atttributes) {
    wrk_scen <- files[[2]]
    
    if (cap_att == "pop_capacity") {grw_att <- "population_growth"} else {grw_att <- "employment_growth"}
    
    # Get Capacity by Station Area
    base_att <- station_summary[variable %in% cap_att & scenario %in% wrk_scen & year %in% analysis_years[[1]]]
    base_att <- base_att[,c("station_name","results")]
    setnames(base_att,c("station_name","capacity"))  

    # Get Scenario Growth by Station Area
    scen_att <- station_summary[variable %in% grw_att & scenario %in% wrk_scen & year %in% analysis_years[[2]]]
    scen_att <- scen_att[,c("station_name","results")]
    setnames(scen_att,c("station_name","growth"))

    # Merge and Calculate the difference
    scen_delta <- merge(base_att, scen_att, by = "station_name")
    scen_delta$results <- scen_delta$capacity - scen_delta$growth
    scen_delta$variable <- paste0(cap_att,"_remaining")
    scen_delta$scenario <- wrk_scen
    scen_delta$year <- analysis_years[[2]]
    scen_delta <- scen_delta[,c("station_name","variable","scenario","results","year")]

    station_summary <- rbind(station_summary,scen_delta)
  }
} 

# Calculate the % of Population and Employment Capacity Used by Scenario
for (files in alternatives) {
  
  base_att <- NULL
  scen_att <- NULL
  scen_delta <- NULL
  grw_att <- NULL

  for (cap_att in cap_atttributes) {
    wrk_scen <- files[[2]]
    
    if (cap_att == "pop_capacity") {grw_att <- "population_growth"} else {grw_att <- "employment_growth"}
    
    # Get Capacity by Station Area
    base_att <- station_summary[variable %in% cap_att & scenario %in% wrk_scen & year %in% analysis_years[[1]]]
    base_att <- base_att[,c("station_name","results")]
    setnames(base_att,c("station_name","capacity"))
    base_att[base_att == 0] <- 1

    # Get Scenario Growth by Station Area
    scen_att <- station_summary[variable %in% grw_att & scenario %in% wrk_scen & year %in% analysis_years[[2]]]
    scen_att <- scen_att[,c("station_name","results")]
    setnames(scen_att,c("station_name","growth"))

    # Merge and Calculate the difference
    scen_delta <- merge(base_att, scen_att, by = "station_name")
    
    if (scen_delta$capacity == 0) {scen_delta$results <- 1} else {scen_delta$results <- scen_delta$growth / scen_delta$capacity}
    
    scen_delta$variable <- paste0(cap_att,"_used")
    scen_delta$scenario <- wrk_scen
    scen_delta$year <- analysis_years[[2]]
    scen_delta <- scen_delta[,c("station_name","variable","scenario","results","year")]

    station_summary <- rbind(station_summary,scen_delta)
  }
} 

# Format Share Columns to be Percentages and centered
short_names <- NULL
for (files in alternatives) {
  short_names <- c(short_names, files[[2]])
  }

# Create Clean Tables
station_pop_growth <- create_station_area_tables(station_summary,alternatives,"population_growth",15)
station_job_growth <- create_station_area_tables(station_summary,alternatives,"employment_growth",15)

station_pop_capacity_remaining <- create_station_area_tables(station_summary,alternatives,"pop_capacity_remaining",15)
station_job_capacity_remaining <- create_station_area_tables(station_summary,alternatives,"job_capacity_remaining",15)

station_pop_capacity_used <- create_station_area_tables(station_summary,alternatives,"pop_capacity_used",15)
for (working_column in short_names) {
  station_pop_capacity_used <- station_pop_capacity_used %>% 
    formatPercentage(working_column, 0) %>%
    formatStyle(working_column,`text-align` = 'center')
  }

station_job_capacity_used <- create_station_area_tables(station_summary,alternatives,"job_capacity_used",15)
for (working_column in short_names) {
  station_job_capacity_used <- station_job_capacity_used %>% 
    formatPercentage(working_column, 0) %>%
    formatStyle(working_column,`text-align` = 'center')
  }
```



The four counties that comprise the Central Puget Sound Region were home to `r toString(format(round(as.numeric(pop_2017), -2), nsmall=0, big.mark=","))` people in 2017. By the year 2050, the population of the region is forecasted to grow to more than `r toString(format(round(as.numeric(pop_2050), -2), nsmall=0, big.mark=","))`, an increase of `r toString(format(round(as.numeric(region_pop_growth), -2), nsmall=0, big.mark=","))` people. Having `r toString(format(round((region_pop_growth/pop_2017)*100,0), nsmall=0))`% more people living, working and playing in the region requires everyone to plan together to ensure that we can accommodate this growth and still maintain the quality of life people enjoy today.

One reason for the continued growth in population is fairly strong forecasted economic growth well into the future. In 2017, there were approximately `r toString(format(round(as.numeric(jobs_2017), -2), nsmall=0, big.mark=","))` total jobs in the four county region. By 2050, the region is expecting another `r toString(format(round(as.numeric(region_job_growth), -2), nsmall=0, big.mark=","))` jobs to be created, an increase of approximately `r toString(format(round((region_job_growth / jobs_2017)*100,0), nsmall=0))`%.

# Growth near Transit

By 2050, more than 100 light rail and streetcar stations are planned in the region. In addition, every county has plans for bus rapid transit and several are planning for commuter rail and passenger-only ferry service expansion. The planning for this integrated regional transit network has been on-going and the latest blueprint for it was adopted in the Regional Transportation Plan (RTP) update in 2018. The charts below illustrate the share of population growth for the `r toString(length(alternatives))` scenarios summarized in this document.

```{r transit_growth_setup, include=FALSE}

s_tbl <- NULL
numeric_columns <- NULL
scenario_names <- NULL

transit_tbl_nms <- c("Rest of Region","Near High Capacity Transit","Near Local Transit")
transit_tbl_ord <- c("Near High Capacity Transit","Near Local Transit","Rest of Region")

# Create a list of Scenario Names
for (files in alternatives) {
  scenario_names <- c(scenario_names, files[[3]])
} 

# Create Summary Table for Display
for (files in alternatives) {
  
  pop_share <- c(sum(unlist(results_by_type[[paste0(files[[2]],"_share_pop_change")]])[1]), sum(unlist(results_by_type[[paste0(files[[2]],"_share_pop_change")]])[c(2:6)]),
sum(unlist(results_by_type[[paste0(files[[2]],"_share_pop_change")]])[7]))
  
  job_share <- c(sum(unlist(results_by_type[[paste0(files[[2]],"_share_job_change")]])[1]), sum(unlist(results_by_type[[paste0(files[[2]],"_share_job_change")]])[c(2:6)]),
sum(unlist(results_by_type[[paste0(files[[2]],"_share_job_change")]])[7]))

  wrk_tbl <- data.table(Area=transit_tbl_nms,People=pop_share,Jobs=job_share)
  
  nms <- c("Area",paste0("population-",files[[2]]),paste0("employment-","-",files[[2]]))
  setnames(wrk_tbl,nms)
  
  numeric_columns <- c(numeric_columns, paste0("population-",files[[2]]),paste0("employment-","-",files[[2]]))
  
  if(is.null(s_tbl)) {s_tbl <- wrk_tbl} else {s_tbl <- merge(s_tbl, wrk_tbl, by = "Area")}
}

s_tbl$Area <- factor(s_tbl$Area, levels = transit_tbl_ord)
s_tbl <- s_tbl[order(Area),]

table_container <- create_table_container('Area Type', scenario_names, c('People','Jobs'))
clean_tbl <- datatable(s_tbl, container = table_container, rownames = FALSE)

# Format Share Columns to be Percentages and centered
for (working_column in numeric_columns) {
  clean_tbl <- clean_tbl %>% 
    formatPercentage(working_column, 0) %>%
    formatStyle(working_column,`text-align` = 'center')
}

plot_tbl <- NULL

for (files in alternatives) {

  pop_share <- c(sum(unlist(results_by_type[[paste0(files[[2]],"_share_pop_change")]])[1]), sum(unlist(results_by_type[[paste0(files[[2]],"_share_pop_change")]])[c(2:6)]),
sum(unlist(results_by_type[[paste0(files[[2]],"_share_pop_change")]])[7]))
  
  job_share <- c(sum(unlist(results_by_type[[paste0(files[[2]],"_share_job_change")]])[1]), sum(unlist(results_by_type[[paste0(files[[2]],"_share_job_change")]])[c(2:6)]),
sum(unlist(results_by_type[[paste0(files[[2]],"_share_job_change")]])[7]))

  wrk_tbl <- data.table(area=transit_tbl_nms,scenario=c(paste0(files[[3]])),People=pop_share,Jobs=job_share)
  
  if (is.null(plot_tbl)) {plot_tbl <- wrk_tbl} else {plot_tbl <- rbind(plot_tbl,wrk_tbl)}

}  

psrc_colors <- c(
    "Near High Capacity Transit" = "#91268F",
    "Near Local Transit" = "#F05A28",
    "Rest of Region" = "#8CC63E",
    "53061" = "#00A7A0")

geo_levels <- c("Near High Capacity Transit","Near Local Transit","Rest of Region")
var_levels <- c("People","Jobs")


# Format table to create stacked bars
wrk_tbl <- melt(plot_tbl, id.vars=c('area','scenario'))

wrk_tbl$area <- factor(wrk_tbl$area, levels = geo_levels)
wrk_tbl <- wrk_tbl[order(area),]

wrk_tbl$variable <- factor(wrk_tbl$variable, levels = var_levels)
wrk_tbl <- wrk_tbl[order(variable),]

wrk_tbl$scenario <- factor(wrk_tbl$scenario, levels = scen_levls)
wrk_tbl <- wrk_tbl[order(scenario),]

w_var <- "People"
w_tbl <- subset(wrk_tbl, variable %in% w_var)

# Create a Pie Chart 
pop_pie <- ggplot(w_tbl, aes(x = "", y = value, fill = area)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text(aes(label = paste0(round(value*100), "%")), color = "white", position = position_stack(vjust = 0.5))+
  scale_fill_manual(values = psrc_colors) +
  theme_void()

pop_pie <- pop_pie + facet_grid(cols = vars(scenario))

w_var <- "Jobs"
w_tbl <- subset(wrk_tbl, variable %in% w_var)

# Create a Pie Chart 
job_pie <- ggplot(w_tbl, aes(x = "", y = value, fill = area)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text(aes(label = paste0(round(value*100), "%")), color = "white", position = position_stack(vjust = 0.5))+
  scale_fill_manual(values = psrc_colors) +
  theme_void()

job_pie <- job_pie + facet_grid(cols = vars(scenario))

w_var <- 'People'
interim <- subset(wrk_tbl, variable %in% w_var & area %in% "Near High Capacity Transit")
min_pop_hct <- min(interim$value)
max_pop_hct <- max(interim$value)

w_var <- 'Jobs'
interim <- subset(wrk_tbl, variable %in% w_var & area %in% "Near High Capacity Transit")
min_job_hct <- min(interim$value)
max_job_hct <- max(interim$value)

```

## Share of Population Growth
For the `r toString(length(alternatives))` scenarios summarized in this document, the share of population growth near High Capcity Transit station areas ranges from `r toString(format(round(min_pop_hct*100,0), nsmall=0))`% to a maximum of `r toString(format(round(max_pop_hct*100,0), nsmall=0))`%. 

```{r plot_pop_pie_charts, echo=FALSE, fig.asp=0.35}
pop_pie
```

## Share of Job Growth
For the `r toString(length(alternatives))` scenarios summarized in this document, the share of job growth near High Capcity Transit station areas ranges from `r toString(format(round(min_job_hct*100,0), nsmall=0))`% to a maximum of `r toString(format(round(max_job_hct*100,0), nsmall=0))`%. Jobs are key driver of transit ridership 

```{r plot_job_pie_charts, echo=FALSE, fig.asp=0.35}
job_pie
```

# Growth by Transit Type {.tabset .tabset.fade .tabset-pills}
As shown in the previous shares of growth charts, a majority of future growth is being planned around the regional transit system for all the alternatives. The key differences between the alternatives is how much growth is located near different types of transit stations. In general, growth near faster and more frequent forms of high capacity transit like light rail tend to result in higher levels of overall transit usage. 

```{r growth-tables, echo = FALSE, include = FALSE, results = 'asis'}
out <- NULL
my_list <- list(1,2,3,4,5)
header_names = list(c("Total","population","employment"), c("Growth","pop_change","job_change"), c("Share of Growth","share_pop_change","share_job_change"), c("Percent of Capacity Used","percent_pop_cap","percent_job_cap"), c("Remaining Capacity","remain_pop_cap","remain_job_cap"))

for (i in seq_along(my_list)) {
  out <- c(out, knitr::knit_child("metric-tables-by-type-child.Rmd"))
}
```

`r paste(out, collapse="\n")`

# Population Growth & Capacity {.tabset .tabset.fade .tabset-pills}
There is a lot of growth planned around transit station areas.

```{r pop-growth-plots, echo = FALSE, include = FALSE, results = 'asis'}
out <- NULL
my_list <- list(1,2,3,4)
lu_att <- "pop"
header_names = list("Light Rail","Commuter Rail","Ferry","Bus Rapid Transit")

for (i in seq_along(my_list)) {
  out <- c(out, knitr::knit_child("plots-by-type-child.Rmd"))
}
```

`r paste(out, collapse="\n")`

# Job Growth & Capacity {.tabset .tabset.fade .tabset-pills}
There is a lot of growth planned around transit station areas.

```{r job-growth-plots, echo = FALSE, include = FALSE, results = 'asis'}
out <- NULL
my_list <- list(1,2,3,4)
lu_att <- "job"
header_names = list("Light Rail","Commuter Rail","Ferry","Bus Rapid Transit")

for (i in seq_along(my_list)) {
  out <- c(out, knitr::knit_child("plots-by-type-child.Rmd"))
}
```

`r paste(out, collapse="\n")`

# Population near Light Rail {.tabset .tabset.fade .tabset-pills}
There is a lot of population growth planned around transit station areas.

```{r station-pop-table, echo = FALSE}
station_pop_growth
```

```{r lrt_station-plots, echo = FALSE, include = FALSE, results = 'asis'}
out <- NULL
my_list <- alternatives
lu_att <- "population_growth"
num_typ <- "integer"

for (i in seq_along(my_list)) {
  out <- c(out, knitr::knit_child("maps-by-station-child.Rmd"))
}

```

`r paste(out, collapse="\n")`

# Population Capacity near Light Rail {.tabset .tabset.fade .tabset-pills}
Many stations would need to upzone to accomodate the planned growth around the station areas in each alternative.

```{r station-pop-capacity-remaining, echo = FALSE}
station_pop_capacity_used
```

```{r lrt_pop-cap-used-plots, echo = FALSE, include = FALSE, results = 'asis'}
out <- NULL
my_list <- alternatives
lu_att <- "pop_capacity_used"
num_typ <- "percentage"

for (i in seq_along(my_list)) {
  out <- c(out, knitr::knit_child("maps-by-station-child.Rmd"))
}

```

`r paste(out, collapse="\n")`

# Job Growth near Light Rail {.tabset .tabset.fade .tabset-pills}
There is a lot of job growth planned around transit station areas.

```{r station-job-table, echo = FALSE}
station_job_growth
```

```{r lrt-job-station-plots, echo = FALSE, include = FALSE, results = 'asis'}
out <- NULL
my_list <- alternatives
lu_att <- "employment_growth"
num_typ <- "integer"

for (i in seq_along(my_list)) {
  out <- c(out, knitr::knit_child("maps-by-station-child.Rmd"))
}

```

`r paste(out, collapse="\n")`

# Job Capacity near Light Rail {.tabset .tabset.fade .tabset-pills}
Many stations would need to upzone to accomodate the planned growth around the station areas in each alternative.

```{r station-job-capacity-remaining, echo = FALSE}
station_job_capacity_used
```

```{r lrt_job-cap-used-plots, echo = FALSE, include = FALSE, results = 'asis'}
out <- NULL
my_list <- alternatives
lu_att <- "job_capacity_used"
num_typ <- "percentage"

for (i in seq_along(my_list)) {
  out <- c(out, knitr::knit_child("maps-by-station-child.Rmd"))
}

```

`r paste(out, collapse="\n")`

# Transportation Metrics
Miles driven per person are lowest in teh Light Rail Focused growth scenario

```{r soundcast_output, include=FALSE}

sc_tbl <- NULL
sc_outputs <- NULL

# First Pull Out Base Year Data 
w_fname <- paste0(getwd(),"/inputs/",soundcast,".xlsx")
sc_outputs <- read_excel(w_fname,sheet = "base_year")
setDT(sc_outputs)
  
annual_boardings <- ntd_boardings_2014
base_model_boardings <- as.integer(sc_outputs[`Data Item` %in% "Daily Transit Boardings" & Geography %in% "Regional" & Grouping %in% "Total",sum(Value)])

# Now Calculate the Scenario Results
for (files in alternatives) {
  
  # Open the Travel Model Outputs 
  w_fname <- paste0(getwd(),"/inputs/",soundcast,".xlsx")
  sc_outputs <- read_excel(w_fname,sheet = files[[2]])
  setDT(sc_outputs)
  
  wrk_pop <- pop_2050
  daily_model_boardings <- as.integer(sc_outputs[`Data Item` %in% "Daily Transit Boardings" & Geography %in% "Regional" & Grouping %in% "Total",sum(Value)])
  delta_boardings <- (daily_model_boardings - base_model_boardings) * annualization
  annual_boardings <-  ntd_boardings_2014 + delta_boardings

  annual_vmt <- (as.integer(sc_outputs[`Data Item` %in% "Daily VMT" & Geography %in% "Regional" & Grouping %in% "Total",sum(Value)])) * annualization
  
  daily_walk_trips <- as.integer(sc_outputs[`Data Item` %in% "All Trip Totals" & Geography %in% "Regional" & Grouping %in% "Walk",sum(Value)])
  daily_bike_trips <- as.integer(sc_outputs[`Data Item` %in% "All Trip Totals" & Geography %in% "Regional" & Grouping %in% "Bike",sum(Value)])
  daily_transit_trips <- as.integer(sc_outputs[`Data Item` %in% "All Trip Totals" & Geography %in% "Regional" & Grouping %in% "Transit",sum(Value)])
  daily_sov_trips <- as.integer(sc_outputs[`Data Item` %in% "All Trip Totals" & Geography %in% "Regional" & Grouping %in% "SOV",sum(Value)])
  daily_hov2_trips <- as.integer(sc_outputs[`Data Item` %in% "All Trip Totals" & Geography %in% "Regional" & Grouping %in% "HOV2",sum(Value)])
  daily_hov3_trips <- as.integer(sc_outputs[`Data Item` %in% "All Trip Totals" & Geography %in% "Regional" & Grouping %in% "HOV3+",sum(Value)])

  daily_non_vehicle_trips <- daily_transit_trips + daily_walk_trips + daily_bike_trips
  daily_non_sov_trips <- daily_non_vehicle_trips + daily_hov2_trips + daily_hov3_trips
  
  vmt_capita <- annual_vmt / wrk_pop
  boardings_capita <- annual_boardings / wrk_pop

  wrk_tbl <- as.data.table(list(Metric=c("Miles per Year","Boardings per Capita","Non-Vehicle Trips"), Scenario=c(files[[2]]), Value=c(vmt_capita,boardings_capita,daily_non_vehicle_trips)))

  if (is.null(sc_tbl)) {sc_tbl <- wrk_tbl} else {sc_tbl <- rbind(sc_tbl,wrk_tbl)}

}

metric_levels <- c("Miles per Year","Boardings per Capita","Non-Vehicle Trips")

# Format table to create stacked bars
wrk_tbl <- melt(sc_tbl, id.vars=c('Metric','Scenario'))

wrk_tbl$Metric <- factor(wrk_tbl$Metric, levels = metric_levels)
wrk_tbl <- wrk_tbl[order(Metric),]

wrk_tbl$Scenario <- factor(wrk_tbl$Scenario, levels = short_names)
wrk_tbl <- wrk_tbl[order(Scenario),]

psrc_colors <- c(
    "Miles per Year" = "#91268F",
    "Boardings per Capita" = "#F05A28",
    "Non-Vehicle Trips" = "#8CC63E",
    "53061" = "#00A7A0")

# Create a Grouped Chart 
wrk_chart <- ggplot(wrk_tbl, aes(Scenario, value)) + geom_bar(aes(fill = Metric), 
  width = 0.4, position = position_dodge(width=0.5), stat="identity") + 
  theme_light()+
  scale_fill_manual(values=psrc_colors)+
  scale_y_continuous(labels = comma)+
  theme(legend.position="bottom", legend.title = 
    element_blank(),axis.title.x=element_blank(), 
    axis.title.y=element_blank())

# Add facets based on Scenario Name and make it interactive
#wrk_chart <- wrk_chart + facet_grid(cols = vars(Metric))
wrk_chart <- wrk_chart + facet_wrap(~ Metric, scales = "free")
working_plot <- ggplotly(wrk_chart) %>% 
  layout(legend = list(orientation = "h", xanchor = "center", x = 0.60, y = -0.1))


```

```{r, plot_sc_outputs, echo=FALSE, results="asis"}
working_plot
```
