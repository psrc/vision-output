---
title: "VISION 2050 Growth Comparisons"
output: html_document
---

```{r general_setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(purrr)
library(ggplot2)
library(data.table)
library(scales)
library(plotly)
library(DT)

# Flag to determine if new lookups should be created
new_geo_lookup <- "no"

# Regional Population and Employment from the Regional Macroforecast 
pop_2017 <- 4066800
hh_pop_2017 <- 3986995
hh_2017 <- 1587176
jobs_2017 <- 2250546

pop_2050 <- 5823165
hh_pop_2050 <- 5720596
hh_2050 <- 2419949
jobs_2050 <- 3391293

# Parcel Files
cap_file <- "parcel_level_capacity"
base <- "parcel__dataset_table__households_jobs__2017"
tfg <- "parcel__dataset_table__households_jobs__2050_tfg"
rug <- "parcel__dataset_table__households_jobs__2050_rug"
ppa65 <- "parcel__dataset_table__households_jobs__2050_ppa65"
transit <- "parcel_id_and_transit_buffer_id"

# Geogrpahic Lookups by parcel
tod_file  <- "tod"
all_transit_file  <- "all_transit"
county_file  <- "county"
minority_file <- "minority"
city_file  <- "city"
povert_file <- "poverty"

# Capacity Column Names
hh_cap_col <- "DUdiff50"
job_cap_col <- "JOBSPdiff50"

# Lists for Analysis
base_year <- list(c(base, "base_year", "Base Year"))
alternatives <- list(c(tfg, "tfg", "Transit Focused Growth"), c(rug, "rug", "Reset Urban Growth"),c(ppa65, "ppa65", "PPA 65/75"))
parcel_files <- c(base_year,alternatives)

cap_atttributes <- list("pop_capacity","job_capacity")
lu_atttributes <- list("population","employment")
tod_types <- list(0,1,2,3,4,5,6,7,8,9,10)
tod_names <- c("Non-HCT","Light Rail: Before 2025","Light Rail: After 2025","Commuter Rail: Before 2025","Commuter Rail: After 2025","Ferry: Before 2025","Ferry: After 2025","Bus Rapid Transit: Before 2025","Bus Rapid Transit: After 2025","Regional Growth Centers","Local Transit")

sum_table_values <- function(tbl, w_scen, w_var, w_tod) {
  
  wrk_tot <- as.integer(tbl[scenario %in% w_scen & variable %in%  w_var & tod_id %in% w_tod,sum(value)])
  return(wrk_tot)
}

create_table_container <- function(cat_nms, scen_nms, metric_nms) {

  wrk_container = htmltools::withTags(table(
    class = 'display',
    thead(
      tr(
        th(class = 'dt-center', rowspan = 3, cat_nms)
      ),
      tr(
        lapply(scen_nms, function(x) th(class = 'dt-center', colspan =2, x))
      ),
          tr(
        lapply(rep(metric_nms, length(scen_nms)), function(x) th(class = 'dt-center', x))
      )
    )
  ))

return(wrk_container)

}

create_geo_lookup <- function(fname, ftype, wrk_cols ,id_nm) {

  to_open <- paste0(getwd(),"/inputs/",fname,ftype)
  if (ftype == ".tab") {wrk_tbl <- read.table(to_open, sep = '\t',header = TRUE)} else {wrk_tbl <- read.csv(to_open)}
  wrk_tbl <- wrk_tbl[,wrk_cols]
  fwrite(wrk_tbl, paste0(getwd(),"/inputs/",id_nm,".csv"))

}

region_pop_growth <-  pop_2050 - pop_2017
region_jobs_growth <-  jobs_2050 - jobs_2017
hh_size <- hh_pop_2050 / hh_2050

# Create new parcel to geogrpahy lookups if necessary
if (new_geo_lookup == "yes") {
  create_geo_lookup(cap_file,".csv",c("parcel_id","tod_id"),"tod")
  create_geo_lookup(cap_file,".csv",c("parcel_id","city_id"),"city")
  create_geo_lookup(transit,".csv",c("parcel_id","transit_buffer_id"),"all_transit")
  create_geo_lookup(ppa65,".tab",c("parcel_id","county_id"),"county")
  create_geo_lookup(ppa65,".tab",c("parcel_id","minority_id"),"minority")
  create_geo_lookup(ppa65,".tab",c("parcel_id","poverty_id"),"poverty")
}  

```

```{r tod_flag_setup, include=FALSE}
# Create a data.table of parcel id's with the TOD area looukps
w_fname <- paste0(getwd(),"/inputs/",tod_file,".csv")
tod_lookup <- read.csv(w_fname)
setDT(tod_lookup)

# Open the All Transit Lookup file 
w_fname <- paste0(getwd(),"/inputs/",all_transit_file,".csv")
all_transit_lookup <- read.csv(w_fname)
setDT(all_transit_lookup)

# Merge the TOD areas and All Transit to add the Local Transit Flag to the TOD ID's (item 10)
parcels_geo <- merge(tod_lookup, all_transit_lookup, by = "parcel_id")
  
# Update TOD Flag to capture Local Transit
parcels_geo$tod_id[parcels_geo$tod_id == 0 & parcels_geo$transit_buffer_id == 1] <- 10
parcels_geo <- parcels_geo[,transit_buffer_id:=NULL]
```

```{r capacity_calualtions, include=FALSE}

# Clear out temporary data.tables
wrk_parcels <- NULL
w_tbl <- NULL

# Open indicator file and store as a data.table with minor cleanup
w_fname <- paste0(getwd(),"/inputs/",cap_file,".csv")
w_tbl <- read.csv(w_fname)
setDT(w_tbl)
cols <- c("parcel_id",hh_cap_col,job_cap_col)
w_tbl <-w_tbl[,..cols]
upd_nms <- c("parcel_id","hh_capacity","job_capacity")
setnames(w_tbl,upd_nms)
w_tbl <- w_tbl[,(upd_nms):= lapply(.SD, as.integer), .SDcols = upd_nms]

# Convert HH Capacity to Population Capacity using the Regional Average Household Size
w_tbl$pop_capacity <- as.integer(w_tbl$hh_capacity * hh_size)
w_tbl <- w_tbl[,hh_capacity:=NULL]

# Join the capacity and TOD Flags
wrk_parcels <- merge(parcels_geo, w_tbl, by = "parcel_id")
wrk_parcels <- melt(wrk_parcels,id.vars = c("parcel_id","tod_id"), measure.vars = c("pop_capacity","job_capacity"))
wrk_parcels$scenario <- "all_scenarios"

# Store the capacity results in the final list
results_by_type = NULL

for (wrk_att in cap_atttributes) {

  calc_by_tod <- partial(sum_table_values, tbl=wrk_parcels, w_scen="all_scenarios", w_var=wrk_att)
  results_by_type[[paste0("all_scenarios_",wrk_att)]] <- map(tod_types,calc_by_tod)
  
}

```

```{r base_calualtions, include=FALSE}

# Values for melted parcels
wrk_measures <- c("population","employment")
wrk_vars <- c("parcel_id","tod_id")
  
# Clear out temporary data.tables
wrk_parcels <- NULL
w_tbl <- NULL

# Open indicator file and store as a data.table with minor cleanup
w_fname <- paste0(getwd(),"/inputs/",base,".tab")
w_tbl <- read.table(w_fname, sep = '\t',header = TRUE)
setDT(w_tbl)
cols <- c("parcel_id",wrk_measures)
w_tbl <- w_tbl[,..cols]
w_tbl <- w_tbl[,(cols):= lapply(.SD, as.integer), .SDcols = cols]

# Join with TOD Flags
wrk_parcels <- merge(parcels_geo, w_tbl, by = "parcel_id")
wrk_parcels <- melt(wrk_parcels, id.vars = wrk_vars, measure.vars = wrk_measures)
wrk_parcels$scenario <- base_year[[1]][[2]]

# Store the results in the final list
for (wrk_att in lu_atttributes) {

  calc_by_tod <- partial(sum_table_values, tbl=wrk_parcels, w_scen=base_year[[1]][[2]], w_var=wrk_att)
  results_by_type[[paste0(base_year[[1]][[2]],"_",wrk_att)]] <- map(tod_types,calc_by_tod)
  
}

```

```{r scenario_calualtions, include=FALSE}

# Values for melted parcels
wrk_measures <- c("population","employment")
wrk_vars <- c("parcel_id","tod_id")
  
# Clear out temporary data.tables
wrk_parcels <- NULL
w_tbl <- NULL
parcels <- NULL

for (files in alternatives) {

  # Read in Scenario Specific Popualtion and Employment Data
  w_fname <- paste0(getwd(),"/inputs/",files[[1]],".tab")
  w_tbl <- read.table(w_fname, sep = '\t',header = TRUE)
  setDT(w_tbl)
  cols <- c("parcel_id",wrk_measures)
  w_tbl <- w_tbl[,..cols]
  w_tbl <- w_tbl[,(cols):= lapply(.SD, as.integer), .SDcols = cols]
  
  # Join with TOD Flags
  wrk_parcels <- merge(parcels_geo, w_tbl, by = "parcel_id")
  wrk_parcels <- melt(wrk_parcels, id.vars = wrk_vars, measure.vars = wrk_measures)
  wrk_parcels$scenario <- files[[2]]
  
  if (is.null(parcels)) {parcels <- wrk_parcels} else {parcels <- rbind(parcels,wrk_parcels)}

}

# Calculate the Total Population and Employment by Scenario and place in a named list
for (files in alternatives) {
  for (lu in lu_atttributes) {
    calc_by_tod <- partial(sum_table_values, tbl=parcels, w_scen=files[[2]], w_var=lu)
    results_by_type[[paste0(files[[2]],"_",lu)]] <- map(tod_types,calc_by_tod)
  }
}

# Calculate various differences from the base year
for (files in alternatives) {
  # Calculate the Change from the Base Year
  results_by_type[[paste0(files[[2]],"_pop_change")]] <- Map('-',  results_by_type[[paste0(files[[2]],"_population")]], results_by_type[["base_year_population"]])
  results_by_type[[paste0(files[[2]],"_job_change")]] <- Map('-',  results_by_type[[paste0(files[[2]],"_employment")]], results_by_type[["base_year_employment"]])

  # Calculate the Share of the Total Change from the Base Year
  total_hh_pop_chg <- sum(unlist(results_by_type[[paste0(files[[2]],"_pop_change")]]))
  total_job_chg <- sum(unlist(results_by_type[[paste0(files[[2]],"_job_change")]]))
  results_by_type[[paste0(files[[2]],"_share_pop_change")]] <- Map('/',  results_by_type[[paste0(files[[2]],"_pop_change")]], total_hh_pop_chg)
  results_by_type[[paste0(files[[2]],"_share_job_change")]] <- Map('/',  results_by_type[[paste0(files[[2]],"_job_change")]], total_job_chg)  
  
  # Calculate the Remaining Capacity
  results_by_type[[paste0(files[[2]],"_remain_pop_cap")]] <- Map('-',  results_by_type[["all_scenarios_pop_capacity"]], results_by_type[[paste0(files[[2]],"_pop_change")]])
  results_by_type[[paste0(files[[2]],"_remain_job_cap")]] <- Map('-',  results_by_type[["all_scenarios_job_capacity"]], results_by_type[[paste0(files[[2]],"_job_change")]])

  # Calculate the Share of remaining Capacity
  results_by_type[[paste0(files[[2]],"_percent_pop_cap")]] <- Map('/',  results_by_type[[paste0(files[[2]],"_pop_change")]], results_by_type[["all_scenarios_pop_capacity"]])
  results_by_type[[paste0(files[[2]],"_percent_job_cap")]] <- Map('/',  results_by_type[[paste0(files[[2]],"_job_change")]], results_by_type[["all_scenarios_job_capacity"]])    
}

```

The four counties that comprise the Central Puget Sound Region were home to `r toString(format(round(as.numeric(pop_2017), -2), nsmall=0, big.mark=","))` people in 2017. By the year 2050, the population of the region is forecasted to grow to more than `r toString(format(round(as.numeric(pop_2050), -2), nsmall=0, big.mark=","))`, an increase of `r toString(format(round(as.numeric(region_pop_growth), -2), nsmall=0, big.mark=","))` people. Having `r toString(format(round((region_pop_growth/pop_2017)*100,0), nsmall=0))`% more people living, working and playing in the region requires everyone to plan together to ensure that we can accommodate this growth and still maintain the quality of life people enjoy today.

One reason for the continued growth in population is fairly strong forecasted economic growth well into the future. In 2017, there were approximately `r toString(format(round(as.numeric(jobs_2017), -2), nsmall=0, big.mark=","))` total jobs in the four county region. By 2050, the region is expecting another `r toString(format(round(as.numeric(region_jobs_growth), -2), nsmall=0, big.mark=","))` jobs to be created, an increase of approximately `r toString(format(round((region_jobs_growth / jobs_2017)*100,0), nsmall=0))`%.



## Population Growth around Transit

VISION 2040, the blueprint for regional growth, was adopted a decade ago. Many things have changed since the adoption of VISION 2040 and one major transportation element has been the construction and commitment to regional high capacity transit. By 2050, more than 100 light rail and streetcar stations are planned in the region. In addition, every county has plans for bus rapid transit and several are planning for commuter rail and passenger-only ferry service expansion. The planning for this integrated regional transit network has been on-going and the latest blueprint for it was adopted in the Regional Transportation Plan (RTP) update in 2018.

```{r transit_growth_setup, include=FALSE}

s_tbl <- NULL
numeric_columns <- NULL
scenario_names <- NULL

transit_tbl_nms <- c("Rest of Region","Near High Capacity Transit","Near Local Transit")
transit_tbl_ord <- c("Near High Capacity Transit","Near Local Transit","Rest of Region")

# Create a list of Scenario Names
for (files in alternatives) {
  scenario_names <- c(scenario_names, files[[3]])
} 

# Create Summary Table for Display
for (files in alternatives) {
  
  pop_share <- c(sum(unlist(results_by_type[[paste0(files[[2]],"_share_pop_change")]])[1]), sum(unlist(results_by_type[[paste0(files[[2]],"_share_pop_change")]])[c(2:10)]),
sum(unlist(results_by_type[[paste0(files[[2]],"_share_pop_change")]])[11]))
  
  job_share <- c(sum(unlist(results_by_type[[paste0(files[[2]],"_share_job_change")]])[1]), sum(unlist(results_by_type[[paste0(files[[2]],"_share_job_change")]])[c(2:10)]),
sum(unlist(results_by_type[[paste0(files[[2]],"_share_job_change")]])[11]))

  wrk_tbl <- data.table(Area=transit_tbl_nms,People=pop_share,Jobs=job_share)
  
  nms <- c("Area",paste0("population-",files[[2]]),paste0("employment-","-",files[[2]]))
  setnames(wrk_tbl,nms)
  
  numeric_columns <- c(numeric_columns, paste0("population-",files[[2]]),paste0("employment-","-",files[[2]]))
  
  if(is.null(s_tbl)) {s_tbl <- wrk_tbl} else {s_tbl <- merge(s_tbl, wrk_tbl, by = "Area")}
}

s_tbl$Area <- factor(s_tbl$Area, levels = transit_tbl_ord)
s_tbl <- s_tbl[order(Area),]

table_container <- create_table_container('Area Type', scenario_names, c('People','Jobs'))
clean_tbl <- datatable(s_tbl, container = table_container, rownames = FALSE)

# Format Share Columns to be Percentages adn centered
for (working_column in numeric_columns) {
  clean_tbl <- clean_tbl %>% 
    formatPercentage(working_column, 0) %>%
    formatStyle(working_column,`text-align` = 'center')
}

plot_tbl <- NULL

for (files in alternatives) {

  pop_share <- c(sum(unlist(results_by_type[[paste0(files[[2]],"_share_pop_change")]])[1]), sum(unlist(results_by_type[[paste0(files[[2]],"_share_pop_change")]])[c(2:10)]),
sum(unlist(results_by_type[[paste0(files[[2]],"_share_pop_change")]])[11]))
  
  job_share <- c(sum(unlist(results_by_type[[paste0(files[[2]],"_share_job_change")]])[1]), sum(unlist(results_by_type[[paste0(files[[2]],"_share_job_change")]])[c(2:10)]),
sum(unlist(results_by_type[[paste0(files[[2]],"_share_job_change")]])[11]))

  wrk_tbl <- data.table(area=transit_tbl_nms,scenario=c(paste0(files[[3]])),People=pop_share,Jobs=job_share)
  
  if (is.null(plot_tbl)) {plot_tbl <- wrk_tbl} else {plot_tbl <- rbind(plot_tbl,wrk_tbl)}

}  

psrc_colors <- c(
    "Near High Capacity Transit" = "#91268F",
    "Near Local Transit" = "#F05A28",
    "Rest of Region" = "#8CC63E",
    "53061" = "#00A7A0")

geo_levels <- c("Near High Capacity Transit","Near Local Transit","Rest of Region")
var_levels <- c("People","Jobs")
scen_levls <- c(alternatives[[1]][[3]],alternatives[[2]][[3]],alternatives[[3]][[3]])

# Format table to create stacked bars
wrk_tbl <- melt(plot_tbl, id.vars=c('area','scenario'))

wrk_tbl$area <- factor(wrk_tbl$area, levels = geo_levels)
wrk_tbl <- wrk_tbl[order(area),]

wrk_tbl$variable <- factor(wrk_tbl$variable, levels = var_levels)
wrk_tbl <- wrk_tbl[order(variable),]

wrk_tbl$scenario <- factor(wrk_tbl$scenario, levels = scen_levls)
wrk_tbl <- wrk_tbl[order(scenario),]

w_var <- "People"
w_tbl <- subset(wrk_tbl, variable %in% w_var)

# Create a Pie Chart 
pop_pie <- ggplot(w_tbl, aes(x = "", y = value, fill = area)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text(aes(label = paste0(round(value*100), "%")), color = "white", position = position_stack(vjust = 0.5))+
  scale_fill_manual(values = psrc_colors) +
  theme_void()

pop_pie <- pop_pie + facet_grid(cols = vars(scenario))

w_var <- "Jobs"
w_tbl <- subset(wrk_tbl, variable %in% w_var)

# Create a Pie Chart 
job_pie <- ggplot(w_tbl, aes(x = "", y = value, fill = area)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text(aes(label = paste0(round(value*100), "%")), color = "white", position = position_stack(vjust = 0.5))+
  scale_fill_manual(values = psrc_colors) +
  theme_void()

job_pie <- job_pie + facet_grid(cols = vars(scenario))
```

```{r plot_pop_pie_charts, echo=FALSE, fig.asp=0.35}
pop_pie
```

## Employment Growth around Transit
Job growth is a key driver of transit use in the region..

```{r plot_job_pie_charts, echo=FALSE, fig.asp=0.35}
job_pie
```

## Population and Employment Growth by Area Type {.tabset .tabset.fade .tabset-pills}

```{r growth-tables, echo = FALSE, include = FALSE, results = 'asis'}
out <- NULL
my_list <- list(1,2,3,4,5)
header_names = list(c("Total","population","employment"), c("Growth","pop_change","job_change"), c("Share of Growth","share_pop_change","share_job_change"), c("Percent of Capacity Used","percent_pop_cap","percent_job_cap"), c("Remaining Capacity","remain_pop_cap","remain_job_cap"))

for (i in seq_along(my_list)) {
  out <- c(out, knitr::knit_child("metric-tables-by-type-child.Rmd"))
}
```

`r paste(out, collapse="\n")`

## Population Growth around Transit Stations {.tabset .tabset.fade .tabset-pills}
There is a lot of growth planned around transit station areas.

```{r pop-growth-plots, echo = FALSE, include = FALSE, results = 'asis'}
out <- NULL
my_list <- list(1,3,5,7)
lu_att <- "pop"
header_names = list("Light Rail","Light Rail","Commuter Rail","Commuter Rail","Ferry","Ferry","Bus Rapid Transit","Bus Rapid Transit")

for (i in seq_along(my_list)) {
  out <- c(out, knitr::knit_child("plots-by-type-child.Rmd"))
}
```

`r paste(out, collapse="\n")`

## Job Growth around Transit Stations {.tabset .tabset.fade .tabset-pills}
There is a lot of growth planned around transit station areas.

```{r job-growth-plots, echo = FALSE, include = FALSE, results = 'asis'}
out <- NULL
my_list <- list(1,3,5,7)
lu_att <- "job"
header_names = list("Light Rail","Light Rail","Commuter Rail","Commuter Rail","Ferry","Ferry","Bus Rapid Transit","Bus Rapid Transit")

for (i in seq_along(my_list)) {
  out <- c(out, knitr::knit_child("plots-by-type-child.Rmd"))
}
```

`r paste(out, collapse="\n")`

