---
title: "VISION 2050 Scenario Outputs"
output:
  html_document: default
---

```{r initial_setup, include = FALSE}
library(data.table)
library(readxl)
library(DT)
library(purrr)

# Input Files
summary_file_date <- "2019-04-17"
housing_type <- "17_housing_type_mix"
job_pop_tod <- "30_jobs_pop_tod_areas"
job_housing <- "18_jobs_housing_ratio"
opportunity <- "79_dist_growth_opp_areas"


# Various Functions to read and summarize files
create_summary_datatable <- function(metric, output_date) {
  summary_file <- paste0(getwd(),"/summary_files/",metric,"_",output_date,".xlsx")
  # List of Scenario Names
  summary_df <- NULL
  scenario_names <- excel_sheets(summary_file)
  
  for (scenario in scenario_names) {
    working_df <- read_excel(summary_file,sheet=scenario)
    if (is.null(summary_df)) {summary_df <- working_df}
    else {summary_df <- rbind(summary_df,working_df)}
  
  }  
  setDT(summary_df)
  return(summary_df)
}

create_table_subset <- function(tbl,geo) {
  
  wrk_tbl <- tbl[geography %in% geo]
  return (wrk_tbl)
} 

create_table_measure <- function(tbl, to_cast, final_order) {
  
  wrk_tbl <- dcast(tbl, type ~ scenario, value.var = to_cast)
  wrk_tbl$type <- factor(wrk_tbl$type, levels = final_order)
  wrk_tbl <- wrk_tbl[order(type),]
  
  return(wrk_tbl)
}

create_table_jhr <- function(tbl, to_cast, final_order) {
  
  wrk_tbl <- dcast(tbl, geography ~ scenario, value.var = to_cast)
  wrk_tbl$geography <- factor(wrk_tbl$geography, levels = final_order)
  wrk_tbl <- wrk_tbl[order(geography),]
  
  return(wrk_tbl)
}

create_table_opportunity <- function(tbl, vars, to_cast, final_order) {
  
  wrk_tbl <- tbl[type %in% vars]
  wrk_tbl <- dcast(wrk_tbl, index ~ scenario, value.var = to_cast)
  wrk_tbl$index <- factor(wrk_tbl$index, levels = final_order)
  wrk_tbl <- wrk_tbl[order(index),]
  
  return(wrk_tbl)
}

create_clean_table <- function(tbl, cols, shr_cols, num_cols, tbl_container) {
  
  wrk_tbl <- tbl[,..cols]
  clean_tbl <- datatable(wrk_tbl, container = tbl_container, rownames = FALSE)
  
  # Format Share Columns to be Percentages adn centered
  for (working_column in shr_cols) {
    clean_tbl <- clean_tbl %>% 
      formatPercentage(working_column, 1) %>%
      formatStyle(working_column,`text-align` = 'center')
  }
  # Format Numeric Columns to have comma separation and centered
  for (working_column in num_cols) {
    clean_tbl <- clean_tbl %>% 
      formatCurrency(working_column, "", digits = 0) %>%
      formatStyle(working_column,`text-align` = 'center')
  }
  
  return(clean_tbl)
}

create_clean_jhr_table <- function(tbl, num_cols, tbl_container) {
  
  clean_tbl <- datatable(tbl, container = tbl_container, rownames = FALSE)
  
  # Format Numeric Columns to have comma separation and centered
  for (working_column in num_cols) {
    clean_tbl <- clean_tbl %>% 
      formatCurrency(working_column, "", digits = 2) %>%
      formatStyle(working_column,`text-align` = 'center')
  }
  
  return(clean_tbl)
}

create_column_names <- function(working_file, summary_date, first_col) {

  # Create the List of Column Names based on the Scenarios in the output file
  scen_nms <- excel_sheets(paste0(getwd(),"/summary_files/",working_file,"_",summary_date,".xlsx"))
  final_columns <- c(first_col,"base_units_PUG-STC","base_share_PUG-STC")
  for (scen in scen_nms) {
    final_columns <- c(final_columns, paste0("future_units_",scen),paste0("future_share_",scen),paste0("share_of_change_",scen))
  }

  # Create List of Columns that should be formatted as percentages
  percent_columns <- c("base_share_PUG-STC")
  for (scen in scen_nms) {
    percent_columns <- c(percent_columns, paste0("future_share_",scen),paste0("share_of_change_",scen))
  }

  numeric_columns <- c("base_units_PUG-STC")
  for (scen in scen_nms) {
    numeric_columns <- c(numeric_columns, paste0("future_units_",scen))
  }
  
  fnl_cols <- list(final_columns,percent_columns,numeric_columns)
  return(fnl_cols)
}

create_column_names_jhr <- function(working_file, summary_date, first_col) {
  
  # Create the List of Column Names based on the Scenarios in the output file
  scen_nms <- excel_sheets(paste0(getwd(),"/summary_files/",working_file,"_",summary_date,".xlsx"))
  final_columns <- c(first_col,"base_index_PUG-STC")
  
  for (scen in scen_nms) {
    final_columns <- c(final_columns, paste0("future_index_",scen),paste0("delta_",scen))
  }

  numeric_columns <- c("base_index_PUG-STC")
  for (scen in scen_nms) {
    numeric_columns <- c(numeric_columns, paste0("future_index_",scen),paste0("delta_",scen))
  }
  
  fnl_cols <- list(final_columns,numeric_columns)
  return(fnl_cols)

}

ht_table_container = htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(rowspan = 2, 'Type'),
      th(rowspan =2, colspan = 2, 'Base Year'),
      th(colspan = 3, 'PUG - Stay the Course'),
      th(colspan = 3, 'PUG - Reset Urban Growth'),
      th(colspan = 3, 'PUG - Transit Focused Growth')
    ),
    tr(
      lapply(rep(c('Units', 'Share', 'Share of Growth'), 3), th)
    )
  )
))

jhr_table_container = htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(rowspan = 2, 'Geography'),
      th(rowspan =2, colspan = 1, 'Base Year'),
      th(colspan = 2, 'PUG - Stay the Course'),
      th(colspan = 2, 'PUG - Reset Urban Growth'),
      th(colspan = 2, 'PUG - Transit Focused Growth')
    ),
    tr(
      lapply(rep(c('Index', 'Change'), 3), th)
    )
  )
))

```

This document contains summary information relevant to multiple Preliminary Urban Growth Scenarios (PUGs) that are being prepared to understand different options for inputs that could be used in an initial Preferred Alernative for VISION 2050. These scenarios were all summarized on `r toString(summary_file_date)`.

## 1. Job/Housing Ratio (indexed to regional average) {.tabset .tabset.fade .tabset-pills}
THe ratio of jobs to housing varies slightly amongst the various scenarios ....

```{r jhr_setup, include=FALSE}
orig_cols <- c("subarea_name","scenario","ehindex_yr2017","ehindex_yr2050")
upd_nms <- c("geography","scenario","base_index","future_index")


# Create Full Measure Data.Table to Cast for Final DT Tables and update column names
measure_dt <- create_summary_datatable(job_housing,summary_file_date)
measure_dt <- measure_dt[,..orig_cols]
setnames(measure_dt, upd_nms)

# Replace the Type description to match the Title in the final tables
measure_dt[measure_dt == "minority"] <- "Minority"
measure_dt[measure_dt == "non-minority"] <- "Non-Minority"

measure_dt[measure_dt == "poverty"] <- "Poverty"
measure_dt[measure_dt == "non-poverty"] <- "Non-Poverty"
measure_dt$delta <- measure_dt$future_index - measure_dt$base_index

# Create List of Column Names
tbl_cols <- create_column_names_jhr(job_housing, summary_file_date, "geography")
```

### Region
Summary of Jobs-Housing Balance by Sub-Areas in the Region.
```{r region_jhr, echo=FALSE, warning=FALSE,message=FALSE}
working_geography <- list("King","Sea-Shore","South King","East King","Kitsap","Pierce","Snohomish","Region")
final_row_order <- c("King","Sea-Shore","South King","East King","Kitsap","Pierce","Snohomish","Region")
values_to_cast <- c("base_index","future_index","delta")

jhr_working <- create_table_subset(measure_dt,working_geography)
jhr_working <- create_table_jhr(jhr_working, values_to_cast, final_row_order)
fnl_cols <- tbl_cols[[1]]
jhr_working <- jhr_working[,..fnl_cols]

clean_table <- create_clean_jhr_table(jhr_working, tbl_cols[[2]], jhr_table_container)
clean_table
```

### Minority
Summary of Jobs-Housing Balance for areas with more than 50% people of color.
```{r minority_jhr, echo=FALSE, warning=FALSE,message=FALSE}
working_geography <- list("Minority","Non-Minority","Region")
final_row_order <- c("Minority","Non-Minority","Region")

jhr_working <- create_table_subset(measure_dt,working_geography)
jhr_working <- create_table_jhr(jhr_working, values_to_cast, final_row_order)
fnl_cols <- tbl_cols[[1]]
jhr_working <- jhr_working[,..fnl_cols]

clean_table <- create_clean_jhr_table(jhr_working, tbl_cols[[2]], jhr_table_container)
clean_table
```

### Poverty
Summary of Jobs-Housing Balance for areas with more than 50% lower income households.
```{r poverty_jhr, echo=FALSE, warning=FALSE,message=FALSE}
working_geography <- list("Poverty","Non-Poverty","Region")
final_row_order <- c("Poverty","Non-Poverty","Region")

jhr_working <- create_table_subset(measure_dt,working_geography)
jhr_working <- create_table_jhr(jhr_working, values_to_cast, final_row_order)
fnl_cols <- tbl_cols[[1]]
jhr_working <- jhr_working[,..fnl_cols]

clean_table <- create_clean_jhr_table(jhr_working, tbl_cols[[2]], jhr_table_container)
clean_table
```

## 2. Population and Job Growth in TOD areas {.tabset .tabset.fade .tabset-pills}
Population and Job growth in transit station areas differs amongst the various scenarios ....

```{r tod_growth_setup, include=FALSE}
orig_cols <- c("Countyname","scenario","indicator","yr2017_tod_actual","yr2017_share_in_tod_actual",               "yr2050_tod","yr2050_share_in_tod","delta_share_in_tod")
upd_nms <- c("geography","scenario","type","base_units","base_share","future_units","future_share","share_of_change")
tod_geography <- list("Region","King","Kitsap","Pierce","Snohomish","minority","poverty")
final_row_order <- c("People","Jobs")
values_to_cast <- c("base_units","base_share","future_units","future_share","share_of_change")

# Create Full Measure Data.Table to Cast for Final DT Tables and update column names
measure_dt <- create_summary_datatable(job_pop_tod,summary_file_date)
measure_dt <- measure_dt[,..orig_cols]
setnames(measure_dt, upd_nms)

# Replace the Type description to match the Title in the final tables
measure_dt[measure_dt == "population"] <- "People"
measure_dt[measure_dt == "employment"] <- "Jobs"

# Create List of Column Names
tbl_cols <- create_column_names(housing_type,summary_file_date,"type")

# Create Partial Function to generate lists of final tables for display and create full list of geography subsets
tbl_subset <- partial(create_table_subset, tbl = measure_dt)
measure_subset <- map(tod_geography, tbl_subset)

# Create a Partial Function to Create the Variable Specific Tables by Geography
tbl_tod <- partial(create_table_measure, to_cast = values_to_cast, final_order=final_row_order)
tod <- map(measure_subset,tbl_tod)
  
# Create a Partial function that does final formats for the data.tables and create them
fmt <- partial(create_clean_table,cols=tbl_cols[[1]],shr_cols=tbl_cols[[2]],num_cols=tbl_cols[[3]],tbl_container=ht_table_container)
final_tod <- map(tod,fmt)
```

### Region
Summary of growth in TOD areas for the entire PSRC Region.
```{r region_tod, echo=FALSE, warning=FALSE,message=FALSE}
final_tod[[1]]
```

### King
Summary of growth in TOD areas for King County.
```{r king_tod, echo=FALSE, warning=FALSE,message=FALSE}
final_tod[[2]]
```

### Kitsap
Summary of growth in TOD areas for Kitsap County.
```{r kitsap_tod, echo=FALSE, warning=FALSE,message=FALSE}
final_tod[[3]]
```

### Pierce
Summary of growth in TOD areas for Pierce County.
```{r pierce_tod, echo=FALSE, warning=FALSE,message=FALSE}
final_tod[[4]]
```

### Snohomish
Summary of growth in TOD areas for Snohomish County.
```{r snohomish_tod, echo=FALSE, warning=FALSE,message=FALSE}
final_tod[[5]]
```

### Minority
Summary of growth in TOD areas for areas with more than 50% people of color.
```{r minority_tod, echo=FALSE, warning=FALSE,message=FALSE}
final_tod[[6]]
```

### Poverty
Summary of growth in TOD areas for areas with more than 50% lower income households.
```{r poverty_tod, echo=FALSE, warning=FALSE,message=FALSE}
final_tod[[7]]
```

## 3. Housing Type Mix {.tabset .tabset.fade .tabset-pills}
Housing Type varies by ....
```{r housing_type_setup, include=FALSE}
orig_cols <- c("geography","scenario","res_density_type","residential_units_base","share_residential_units_base","residential_units_yr2050","share_residential_units_yr2050","share_delta")
upd_nms <- c("geography","scenario","type","base_units","base_share","future_units","future_share","share_of_change")
hsg_geography <- list("Region","King","Kitsap","Pierce","Snohomish","minority","poverty")
final_row_order <- c("Low density (<12 DU/acre)","Moderate density (12-49 DU/acre)","High density (50+ DU/acre)")
values_to_cast <- c("base_units","base_share","future_units","future_share","share_of_change")

# Create Full Measure Data.Table to Cast for Final DT Tables and update column names
measure_dt <- create_summary_datatable(housing_type,summary_file_date)
measure_dt <- measure_dt[,..orig_cols]
setnames(measure_dt, upd_nms)

# Replace the Type description to match the Title in the final tables
measure_dt[measure_dt == "low"] <- "Low density (<12 DU/acre)"
measure_dt[measure_dt == "med"] <- "Moderate density (12-49 DU/acre)"
measure_dt[measure_dt == "high"] <- "High density (50+ DU/acre)"

# Create List of Column Names
tbl_cols <- create_column_names(housing_type,summary_file_date,"type")

# Create Partial Function to generate lists of final tables for display and create full list of geography subsets
tbl_subset <- partial(create_table_subset, tbl = measure_dt)
measure_subset <- map(hsg_geography, tbl_subset)

# Create a Partial Function to Create the Variable Specific Tables by Geography
tbl_ht <- partial(create_table_measure, to_cast = values_to_cast, final_order=final_row_order)
ht <- map(measure_subset,tbl_ht)
  
# Create a Partial function that does final formats for the data.tables and create them
fmt <- partial(create_clean_table,cols=tbl_cols[[1]],shr_cols=tbl_cols[[2]],num_cols=tbl_cols[[3]],tbl_container=ht_table_container)
final_ht <- map(ht,fmt)
```

### Region
Summary of Housing Type Mix for the entire PSRC Region.
```{r region_ht, echo=FALSE, warning=FALSE,message=FALSE}
final_ht[[1]]
```

### King County
Summary of Housing Type Mix for King County.
```{r king_ht, echo=FALSE, warning=FALSE,message=FALSE}
final_ht[[2]]
```

### Kitsap County
Summary of Housing Type Mix for Kitsap County.
```{r kitsap_ht, echo=FALSE, warning=FALSE,message=FALSE}
final_ht[[3]]
```

### Pierce County
Summary of Housing Type Mix for Pierce County.
```{r pierce_ht, echo=FALSE, warning=FALSE,message=FALSE}
final_ht[[4]]
```

### Snohomish County
Summary of Housing Type Mix for Snohomish County.
```{r snohomish_ht, echo=FALSE, warning=FALSE,message=FALSE}
final_ht[[5]]
```

### Minority
Summary of Housing Type Mix for areas with more than 50% people of color.
```{r minority_ht, echo=FALSE, warning=FALSE,message=FALSE}
final_ht[[6]]
```

### Poverty
Summary of Housing Type Mix for areas with more than 50% lower income households.
```{r poverty_ht, echo=FALSE, warning=FALSE,message=FALSE}
final_ht[[7]]
```

## 4. Growth in Opportunity Areas {.tabset .tabset.fade .tabset-pills}
Gowth varies by ....
```{r opportunity_type_setup, include=FALSE}
orig_cols <- c("county","scenario","indicator","index","yr2017_actual","share_yr2017_actual","yr2050","share_yr2050","share_delta")
upd_nms <- c("geography","scenario","type","index", "base_units","base_share","future_units","future_share","share_of_change")
opp_geography <- list("Region","King","Kitsap","Pierce","Snohomish","minority","poverty")
values_to_cast <- c("base_units","base_share","future_units","future_share","share_of_change")
final_row_order <- c("Very Low","Low","Moderate","High","Very High","Moderate to Very High")

# Create List of Column Names
tbl_cols <- create_column_names(opportunity,summary_file_date,"index")

# Create Full Measure Data.Table to Cast for Final DT Tables and update column names
measure_dt <- create_summary_datatable(opportunity,summary_file_date)
measure_dt <- measure_dt[,..orig_cols]
setnames(measure_dt, upd_nms)

# Create Partial Functions to generate lists of final tables for display and create full list of geography subsets
tbl_subset <- partial(create_table_subset, tbl = measure_dt)
measure_subset <- map(opp_geography, tbl_subset)

# Create a Partial Function to Create the Variable Specific Tables by Geography
opp <- partial(create_table_opportunity, vars = wrk_vars, to_cast = values_to_cast, final_order=final_row_order)

# Create Population, Household and Employment Lists of data.tables
wrk_vars <- "population"
opp_pop <- map(measure_subset,opp)
  
wrk_vars <- "households"
opp_hh <- map(measure_subset,opp)

wrk_vars <- "employment"
opp_emp <- map(measure_subset,opp)

# Create a Partial function that does final formats for the data.tables and create them
fmt <- partial(create_clean_table,cols=tbl_cols[[1]],shr_cols=tbl_cols[[2]],num_cols=tbl_cols[[3]],tbl_container=ht_table_container)

final_pop <- map(opp_pop,fmt)
final_hh <- map(opp_hh,fmt)
final_emp <- map(opp_emp,fmt)
```

### Region
Summary of growth in opportunity areas for the entire PSRC Region.

```{r region_opp, echo=FALSE, warning=FALSE,message=FALSE, results='asis'}
results <- 1

cat("**Population by Area of Opportunity**","  \n")
final_pop[[results]]

cat("**Households by Area of Opportunity**","  \n")
final_hh[[results]]

cat("**Jobs by Area of Opportunity**","  \n")
final_emp[[results]]
```

### King
Summary of growth in opportunity areas for King County.

```{r king_opp, echo=FALSE, warning=FALSE,message=FALSE, results='asis'}
results <- 2

cat("**Population by Area of Opportunity**","  \n")
final_pop[[results]]

cat("**Households by Area of Opportunity**","  \n")
final_hh[[results]]

cat("**Jobs by Area of Opportunity**","  \n")
final_emp[[results]]
```

### Kitsap
Summary of growth in opportunity areas for Kitsap County.

```{r kitsap_opp, echo=FALSE, warning=FALSE,message=FALSE, results='asis'}
results <- 3

cat("**Population by Area of Opportunity**","  \n")
final_pop[[results]]

cat("**Households by Area of Opportunity**","  \n")
final_hh[[results]]

cat("**Jobs by Area of Opportunity**","  \n")
final_emp[[results]]
```

### Pierce
Summary of growth in opportunity areas for Pierce County.

```{r pierce_opp, echo=FALSE, warning=FALSE,message=FALSE, results='asis'}
results <- 4

cat("**Population by Area of Opportunity**","  \n")
final_pop[[results]]

cat("**Households by Area of Opportunity**","  \n")
final_hh[[results]]

cat("**Jobs by Area of Opportunity**","  \n")
final_emp[[results]]
```

### Snohomish
Summary of growth in opportunity areas for Snohomish County.

```{r snohomish_opp, echo=FALSE, warning=FALSE,message=FALSE, results='asis'}
results <- 5

cat("**Population by Area of Opportunity**","  \n")
final_pop[[results]]

cat("**Households by Area of Opportunity**","  \n")
final_hh[[results]]

cat("**Jobs by Area of Opportunity**","  \n")
final_emp[[results]]
```

### Minority
Summary of growth in opportunity areas for areas with more than 50% people of color.

```{r minority_opp, echo=FALSE, warning=FALSE,message=FALSE, results='asis'}
results <- 6

cat("**Population by Area of Opportunity**","  \n")
final_pop[[results]]

cat("**Households by Area of Opportunity**","  \n")
final_hh[[results]]

cat("**Jobs by Area of Opportunity**","  \n")
final_emp[[results]]
```

### Poverty
Summary of growth in opportunity areas for areas with more than 50% lower income households.

```{r poverty_opp, echo=FALSE, warning=FALSE,message=FALSE, results='asis'}
results <- 7

cat("**Population by Area of Opportunity**","  \n")
final_pop[[results]]

cat("**Households by Area of Opportunity**","  \n")
final_hh[[results]]

cat("**Jobs by Area of Opportunity**","  \n")
final_emp[[results]]
```