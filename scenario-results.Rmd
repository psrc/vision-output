---
title: "Technical Analysis for VISION 2050 "
output: 
  html_document:
    theme: cerulean
    toc: false
    toc_float: false
    number_sections: false
---

VISION 2050 is the shared regional plan for moving toward a sustainable future. It encourages decision-makers to make wise use of existing resources and planned transit investments while achieving the region’s shared vision. VISION 2050 sets forth a pathway that strengthens economic, social, and environmental resiliency, while enhancing the region’s ability to cope with adverse trends such as climate change and unmet housing needs. As the region experiences more growth, VISION 2050 seeks to provide housing, mobility options, and services in more sustainable ways. Most importantly, VISION 2050 is a call to action to meet the needs of a growing population while considering the current needs of residents. VISION 2050 recognizes that clean air, health, life expectancy, and access to jobs and good education can vary dramatically by neighborhood. VISION 2050 works to rectify the inequities of the past, especially for communities of color and people with low incomes.

This document summarizes some of the key technical inputs for the VISION 2050 update. For more information on VISION 2050, please refer to https://www.psrc.org/vision.

```{r inputs_to_code, include=FALSE}

wrk_scenario <- "Wild Bill"
analysis_years <- c(2017,2050)
annualization <- 320
travel_model_base_year <- 2014
network_buffer <- "yes"
regional_geography_used <- "proposed"

create_geo_map <- FALSE
plot_geo_map <- FALSE

# Service Hours from Soundcast
hours_2050 <- 12735000

# Central Database name and server
server_name <- "AWS-PROD-SQL\\COHO"
database_name <- "Sandbox"

results_folder <- ":/vision2050/opusgit/urbansim_data/data/psrc_parcel/runs/"

# Values for MSA Comparisons
base_month <- 5
area_type <- "statistical area"
pop_threshold <- 1000000

transit_variables <- c("UPT","VRH")
psrc_uza <- c(14,180)

sister_msa <- c(14460,41860,12060,33100,37980,47900,26420,19100)

# Soundcast Outlocations
soundcast_folder <- "L:/vision2050/soundcast/wild_bill/2050/outputs/network"
output_folder <- "C:/coding/vision-output/outputs"

```

```{r general_setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(purrr)
library(ggplot2)
library(data.table)
library(scales)
library(plotly)
library(DT)
library(leaflet)
library(sp)
library(rgdal)
library(readxl)
library(foreign)
library(odbc)
library(DBI)
library(knitr)
library(lubridate)
library(rgeos)
library(tidyverse)
library(zoo)
library(reticulate)

us_nm <- Sys.getenv("USERNAME")

# Model Run Tracking file on TEAMS
run_track_file <- paste0('C:/Users/',us_nm,'/Puget Sound Regional Council/v2050 scenarios - Modeling and run tracking/model_run_tracking.xlsx')
model_tracker <- read_excel(run_track_file,sheet = "Runs by Key Inputs",skip=2)
setDT(model_tracker)

# Set folder location for parcel file indicator
current_run <- model_tracker[`Run Name Alias` %in% wrk_scenario]
drive <- substr(as.character(current_run$Indicators), start=1,stop=1)
mdl_srv <- paste0("awsmodel",as.character(current_run$`Run On:`))
mdl_run <- as.character(current_run$`UrbanSim Run ID and Time Stamp`)
parcel_file_path <- paste0(drive,results_folder,mdl_srv,"/",mdl_run,"/indicators/")

# Color Pallete using PSRC Colors
psrc_colors <- c(
    "High Capacity Transit" = "#91268F",
    "Local Transit" = "#F05A28",
    "Rest of Region" = "#8CC63E",
    "Lower Share of People of Color" = "#F05A28",
    "Higher Share of People of Color" = "#8CC63E",
    "Lower share of Low Income People" = "#8CC63E",
    "Higher share of Low Income People" = "#00A7A0",
    "Near Transit" = "#91268F",
    "Outside Transit Buffer" = "#00A7A0",    
    "King" = "#91268F",
    "Kitsap" = "#F05A28",
    "Pierce" = "#8CC63E",    
    "Snohomish" = "#00A7A0",
    "Light Rail" = "#91268F",
    "Commuter Rail" = "#F05A28",
    "Ferry" = "#8CC63E",    
    "Bus Rapid Transit" = "#00A7A0",
    "Regional Growth Centers" = "#76787A",    
    "Local Transit" = "#8CC63E",    
    "Non-HCT" = "#BBBDC0",
    "No Transit" = "#BBBDC0",
    "Metro" = "#91268F",
    "Core" = "#F05A28",
    "HCT" = "#8CC63E",
    "Cities & Towns" = "#00A7A0",
    "Urban Unincorporated" = "#76787A",
    "Rural" = "#BBBDC0",
    "NW Snohomish" = "#76787A",
    "Everett" = "#F05A28",
    "SW Snohomish" = "#00A7A0",
    "Snohomish Other" = "#91268F",
    "Shoreline" = "#76787A",
    "Seattle" = "#F05A28",
    "Eastside King" = "#8CC63E",
    "SW King" = "#00A7A0",
    "Green River" = "#91268F",
    "SE King" = "#76787A",
    "King Other" = "#F05A28",
    "Tacoma" = "#8CC63E",
    "SW Pierce" = "#00A7A0",
    "Pierce Other" = "#91268F",
    "Peninsula" = "#76787A",
    "South Kitsap" = "#F05A28",
    "Central Kitsap" = "#8CC63E",
    "North Kitsap" = "#00A7A0")

# Colors for Bar Charts
bar_colors <- c(
    "0" = "#BBBDC0",
    "1" = "#F05A28",
    "2" = "#8CC63E",
    "3" = "#00A7A0",
    "Today" = "#BBBDC0",
    "2050" = "#F05A28",
    "SOV" = "#91268F",
    "HOV2" = "#F05A28",
    "HOV3+" = "#8CC63E",
    "Transit" = "#00A7A0",
    "School Bus" = "#00A7A0",
    "Walk" = "#76787A",
    "Bike" = "#BBBDC0")

# Parcel Capacity File
cap_file <- "parcel_level_capacity"

# Macroeconimic forecast
macro <- "2018psrc-macroeconomicforecast"

# Travel Model Outputs
soundcast <- "soundcast_screening_factors"
sc_trips <- "trips_by_mode_and_purpose"

# MSA Job Data
msa_jobs <- "msa_employment_2017"

# Urban Area VMT Data
uza_vmt <- "uza-vmt"

# Urban Area to MSA Lookup
uza_ua_codes <- "uza_ua_codes"

# Geographic Lookups by parcel
parcel_file <- "parcel_ids"
all_transit_file  <- "all_transit"
county_file  <- "county"
minority_file <- "minority"
city_file  <- "city"
poverty_file <- "poverty"
lrt_stations <- "lrt_stations"
rgc <- "regional_growth_centers"
regional_geo <- "cities_king_paa"
large_areas_file <- "large_area"
rgc_tod_file <- "rgc_tod"
ferry_buffer_upd_file <- "ferry_updates"

if (network_buffer == "yes") {tod_file<-"tod_network"} else {tod_file<-"tod_linear"}

# TOD Types with a consistent definition amongst network buffer types
tod_types <- list(100,101,102,103,104,105,106,100:106)
tod_names <- c("Non-HCT","Light Rail","Commuter Rail","Ferry","Bus Rapid Transit","Regional Growth Centers","Local Transit","Total")
tod_order <- c("Light Rail","Commuter Rail","Ferry","Bus Rapid Transit","Regional Growth Centers","Local Transit","Non-HCT","Total")

rgc_tod_types <- list(100,101,102,103,104,105,106,100:106)
rgc_tod_names <- c("Non-HCT","Light Rail","Commuter Rail","Ferry","Bus Rapid Transit","Regional Growth Centers","Local Transit","Total")
rgc_tod_order <- c("Regional Growth Centers","Light Rail","Commuter Rail","Ferry","Bus Rapid Transit","Local Transit","Non-HCT","Total")

hct_types <- list(0,1,2,0:2)
hct_names <- c("No Transit","High Capacity Transit","Local Transit","Total")
hct_order <- c("High Capacity Transit","Local Transit","No Transit","Total")

transit_buffer_types <- list(0,1,list(0,1))
transit_names <- c("Outside Transit Buffer", "Near Transit","Total")
transit_order <- c("Near Transit", "Outside Transit Buffer","Total")

county_types <- list(33,35,53,61,list(33,35,53,61))
county_names <- c("King", "Kitsap", "Pierce", "Snohomish","Total")
county_order <- county_names

minority_types <- list(1,2,1:2)
minority_names <- c("Lower Share of People of Color", "Higher Share of People of Color","Total")

poverty_types <- list(1,2,1:2)
poverty_names <- c("Lower share of Low Income People", "Higher share of Low Income People","Total")

if (regional_geography_used == "proposed") {
  rgeo_types <- list(1,2,3,4,5,6,1:6)
  rgeo_names <- c("Metro","Core","HCT","Cities & Towns","Urban Unincorporated","Rural","Total")
  rgeo_order <- rgeo_names
  rgeo_id <- "rgs_proposed_id"

} else {
  rgeo_types <- list(1,2,3,4,5,6,1:6)
  rgeo_names <- c("Metro","Core","Larger","Small","Urban Unincorporated","Rural","Total")
  rgeo_order <- rgeo_names
  rgeo_id <- "rgs_id"  
}

la_types <- list(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18, 1:18)
la_names <- c("NW Snohomish","Everett","SW Snohomish","Snohomish Other","Shoreline","Seattle","Eastside King","SW King","Green River","SE King","King Other","Tacoma","SW Pierce","Pierce Other","Peninsula","South Kitsap","Central Kitsap","North Kitsap","Total")
la_order <- la_names
la_id <- "large_area_id" 

# Flags to determine the geographic lookup to add to the parcel results for summary
parcel_lookups <- list(list("tod_id",tod_file,tod_types, tod_names, tod_order,"Transit Type"),list("county_id",county_file,county_types, county_names,county_names,"County"),list("minority_id",minority_file,minority_types,minority_names,minority_names,"Minority"),list("poverty_id",poverty_file,poverty_types,poverty_names,poverty_names,"Low Income"),list("transit_buffer_id",all_transit_file,transit_buffer_types,transit_names,transit_order,"All Transit"),list("large_area_id",large_areas_file,la_types,la_names,la_order,"Large Areas"),list("rgc_tod_id",rgc_tod_file,rgc_tod_types, rgc_tod_names, rgc_tod_order,"RGC and Transit Type"))

county_lookups <- list(list(33,35,53,61,list(33,35,53,61)),list("King", "Kitsap", "Pierce", "Snohomish","Region"))

# Capacity Column Names
hh_cap_col <- "DUdiff50"
job_cap_col <- "JOBSPdiff50"

cap_atttributes <- list("pop_capacity","job_capacity")
lu_atttributes <- list("population","employment","housing_units")
cap_atttributes <- list("pop_capacity","job_capacity")

# Lists for Analysis
run_description <- as.character(current_run$`Quick Description`)
run_short <- as.character(current_run$`Run Name Alias`)
alternatives <- list(c(wrk_scenario, run_short, run_description))
scen_levls <- c(alternatives[[1]][[3]])

# Create a list of Scenario Names
scenario_names <- NULL
  for (files in alternatives) {
  scenario_names <- c(scenario_names, files[[3]])
}

source("functions.R")

# Basic Scenario Assumptions
if (is.na(current_run$`Fully Int`)) {integrated_run <- "No"} else {integrated_run <- "Yes"}
if (is.na(current_run$`Parcels in Network Distance`)) {buffer <- "Linear Buffer"} else {buffer <- "Network Buffer"}
if (is.na(current_run$`Special model used in  Alloc (LUV) Years`)) {luv_dm <- "Off"} else {luv_dm <- "On"}
```
# Scenario Assumptions

**Scenario Name: ** `r toString(run_short)`   
**Quick Description: ** `r toString(run_description)`   
**Integrated Run: ** `r toString(integrated_run)`   
**Buffer Type: ** `r toString(buffer)`   
**LUV Year Developer Model: ** `r toString(luv_dm)`   
**Location of UrbanSim Indicator Files: ** `r toString(parcel_file_path)`   

```{r macroforecast_information, include=FALSE}

# Grab Macroforecast Data from Database
macro_forecast <- table_from_db(server_name,database_name,"Craig.macroeconomic_forecast")
setDT(macro_forecast)

# Regional Population and Employment from the Regional Macroforecast 
base_pop <- as.integer(macro_forecast[category %in% "Population" & variable %in% "Total" & year %in% analysis_years[[1]],sum(value)])
base_jobs <- as.integer(macro_forecast[category %in% "Estimated Total Employment" & variable %in% "Total" & year %in% analysis_years[[1]],sum(value)])

horizon_pop <- as.integer(macro_forecast[category %in% "Population" & variable %in% "Total" & year %in% analysis_years[[2]],sum(value)])
horizon_jobs <- as.integer(macro_forecast[category %in% "Estimated Total Employment" & variable %in% "Total" & year %in% analysis_years[[2]],sum(value)])
hh_size <- as.numeric(macro_forecast[category %in% "Households" & variable %in% "Average Household Size" & year %in% analysis_years[[2]],sum(value)])

region_pop_growth <- horizon_pop - base_pop
region_job_growth <- horizon_jobs - base_jobs

# Create various displays of macroforecast data between the base and horizon years
working_years <- (analysis_years[[1]]:analysis_years[[2]])

# Total Population
working_data <- macro_forecast[category %in% "Population" & variable %in% "Total" & year %in% working_years]
region_pop_chart <- create_line_chart(working_data,working_data$year,working_data$value,working_data$variable,6000000,"Total Population","Year","Total Regional Population")

# Household Size
working_data <- macro_forecast[category %in% "Households" & variable %in% "Average Household Size" & year %in% working_years]
region_hhsize_chart <- create_line_chart(working_data,working_data$year,working_data$value,working_data$variable,4,"Average Household Size","Year","Average Regional Household Size")

# Growth by Age
age_groups <- c("0-4","5-19","20-64","65+")
working_data <- macro_forecast[category %in% "Population" & variable %in% age_groups & year %in% working_years]
region_age_chart <- create_line_chart(working_data,working_data$year,working_data$value,working_data$variable,4000000,"Population","Year","Regional Population by Age Group")

# Total Employment
working_data <- macro_forecast[category %in% "Estimated Total Employment" & variable %in% "Total" & year %in% working_years]
region_job_chart <- create_line_chart(working_data,working_data$year,working_data$value,working_data$variable,3500000,"Total Employment","Year","Total Regional Employment")

# Jobs by Sector
job_sectors <- c("Const/Res","FIRE","Manufacturing","Retail","Services","WTU","Government","Education","Uniformed Military")
working_data <- macro_forecast[category %in% "Estimated Total Employment" & variable %in% job_sectors & year %in% working_years]
region_sector_chart <- create_line_chart(working_data,working_data$year,working_data$value,working_data$variable,2000000,"Total Employment","Year","Regional Employment by Sector")


```

# Regional Macroeconomic Forecast {.tabset .tabset.fade .tabset-pills}
PSRC forecasts the region's households, persons, jobs, and other economic and demographic variables through the year 2050. The Macroeconomic Forecast is an input to PSRC's land use and travel forecasting and provides the growth assumptions used in our regional growth strategy. It is developed by PSRC with help and review by technical staff from state and local government. PSRC uses an in-house econometric model system whose equations are estimated using over four decades of historical data along with a national macroeconomic forecast and a regional aerospace forecast that are developed separately and combined to create the regional forecast.

## Population
The four counties that comprise the Central Puget Sound Region were home to `r toString(format(round(as.numeric(base_pop), -2), nsmall=0, big.mark=","))` people in `r toString(analysis_years[[1]])`. By the year `r toString(analysis_years[[2]])`, the population of the region is forecasted to grow to more than `r toString(format(round(as.numeric(horizon_pop), -2), nsmall=0, big.mark=","))`, an increase of `r toString(format(round(as.numeric(region_pop_growth), -2), nsmall=0, big.mark=","))` people. Having `r toString(format(round((region_pop_growth/base_pop)*100,0), nsmall=0))`% more people living, working and playing in the region requires everyone to plan together to ensure that we can accommodate this growth and still maintain the quality of life people enjoy today.

```{r region_pop, echo = FALSE}
region_pop_chart
```

```{r pop_age_data, include = FALSE}
age_results <- NULL
age_groups <- c("0-4","5-19","20-64","65+","Total")
age_years <- c(2017,2020,2025,2030,2035,2040,2045,2050)
wrk_category <- "Population"

sum_age_values <- function(tbl, w_cat, w_var, w_yr) {
  wrk_tot <- as.integer(tbl[category %in% w_cat & variable %in%  w_var & year %in% w_yr,sum(value)])
  return(wrk_tot)
}

# Calcualte the Population by Age Cohort and Analysis Year
for (wrk_age in age_groups ) {
  for (years in age_years) {
    w_tot <- as.integer(macro_forecast[category %in% "Population" & variable %in% "Total" & year %in% years,sum(value)])
    calc_by_age <- partial(sum_age_values, tbl= macro_forecast, w_cat = wrk_category, w_yr=years)
    age_results[[paste0(wrk_category,"_",years,"_age_",wrk_age)]] <- map(wrk_age,calc_by_age)
    age_results[[paste0(wrk_category,"_",years,"_age_",wrk_age,"_Share")]] <- as.integer(age_results[[paste0(wrk_category,"_",years,"_age_",wrk_age)]]) / w_tot
  }
}

```

## By Age
The working age population (ages 20-64) make up a majority of the population throughout the forecast horizon, ranging from `r toString(format(round(as.numeric(age_results[[paste0("Population_",analysis_years[[1]],"_age_20-64_Share")]])*100,1),nsmall=0, big.mark=","))`% in `r toString(analysis_years[[1]])` to `r toString(format(round(as.numeric(age_results[[paste0("Population_",analysis_years[[2]],"_age_20-64_Share")]])*100,1),nsmall=0, big.mark=","))`% in `r toString(analysis_years[[2]])`. The aging of the population is reflected in the growing share of people who are over 65 years of age - from approximately `r toString(format(round(as.numeric(age_results[[paste0("Population_",analysis_years[[1]],"_age_65+_Share")]])*100,1),nsmall=0, big.mark=","))`% in `r toString(analysis_years[[1]])` to `r toString(format(round(as.numeric(age_results[[paste0("Population_",analysis_years[[2]],"_age_65+_Share")]])*100,1),nsmall=0, big.mark=","))`% in `r toString(analysis_years[[2]])`. By the year 2030, there are forecasted to be more people over the age of 65 than school age children making it the second largest age-cohort in the later years of the forecast. The share of population under the age of 5 remains fairly consistent at `r toString(format(round(as.numeric(age_results[[paste0("Population_",analysis_years[[1]],"_age_0-4_Share")]])*100,1),nsmall=0, big.mark=","))`% in `r toString(analysis_years[[1]])` and `r toString(format(round(as.numeric(age_results[[paste0("Population_",analysis_years[[2]],"_age_0-4_Share")]])*100,1),nsmall=0, big.mark=","))`% in `r toString(analysis_years[[2]])`.

```{r pop_age_chart, echo = FALSE}
region_age_chart
```

```{r hh_size_data, include = FALSE}
size_results <- NULL
size_years <- c(2017,2020,2025,2030,2035,2040,2045,2050)
size_category <- c("Average Household Size")

sum_hhsize <- function(tbl, w_cat, w_var, w_yr) {
  wrk_tot <- as.numeric(tbl[category %in% w_cat & variable %in%  w_var & year %in% w_yr,sum(value)])
  return(wrk_tot)
}

for (years in age_years) {
  calc_by_size <- partial(sum_hhsize, tbl= macro_forecast, w_cat = "Households", w_yr=years)
  size_results[[paste0("hhsize_",years)]] <- map(size_category,calc_by_size)
}

```

## HH Size
The average household size has been steadily declining since the 1970's and this trend is forecasted to continue out to `r toString(analysis_years[[2]])`. In `r toString(analysis_years[[1]])`, the average household size was `r toString(format(round(as.numeric(size_results[[paste0("hhsize_",analysis_years[[1]])]]),2),nsmall=0, big.mark=","))`. By `r toString(analysis_years[[2]])`, the average household size is forecasted to decline to `r toString(format(round(as.numeric(size_results[[paste0("hhsize_",analysis_years[[2]])]]),2),nsmall=0, big.mark=","))`. Fewer people living in each household has implications on the number of housing units that will be required to house the same number of people in 2050 and likely the size and type of housing that the future popualtion will desire.

```{r hhsize_chart, echo = FALSE}
region_hhsize_chart
```

## Employment
One reason for the continued growth in population is forecasted economic growth well into the future. In `r toString(analysis_years[[1]])`, there were approximately `r toString(format(round(as.numeric(base_jobs), -2), nsmall=0, big.mark=","))` total jobs in the four county region. By `r toString(analysis_years[[2]])`, the region is expecting another `r toString(format(round(as.numeric(region_job_growth), -2), nsmall=0, big.mark=","))` jobs to be created, an increase of approximately `r toString(format(round((region_job_growth / base_jobs)*100,0), nsmall=0))`%.

```{r region_jobs, echo = FALSE}
region_job_chart
```

```{r emp_sector_data, include = FALSE}
sector_results <- NULL
sector_years <- c(2017,2020,2025,2030,2035,2040,2045,2050)
sector_category <- c("Const/Res","FIRE","Manufacturing","Retail","Services","WTU","Government","Education","Uniformed Military")

sum_sectors <- function(tbl, w_cat, w_var, w_yr) {
  wrk_tot <- as.numeric(tbl[category %in% w_cat & variable %in%  w_var & year %in% w_yr,sum(value)])
  return(wrk_tot)
}

for (w_sector in sector_category) {
  for (years in sector_years) {
    w_tot <- as.integer(macro_forecast[category %in% "Estimated Total Employment" & variable %in% "Total" & year %in% years,sum(value)])
    calc_by_sector <- partial(sum_sectors, tbl= macro_forecast, w_cat = "Estimated Total Employment", w_yr=years)
    sector_results[[paste0(w_sector,"_jobs_",years)]] <- map(w_sector,calc_by_sector)
    sector_results[[paste0(w_sector,"_share_of_jobs_",years)]] <- as.integer(sector_results[[paste0(w_sector,"_jobs_",years)]]) / w_tot
  }
}

```

## By Sector
Employment growth for the foreast period is greastest within the Services and Retil categories of the economoy between `r toString(analysis_years[[1]])` and `r toString(analysis_years[[2]])`. Services, a broad category that includes firms like Amazon and Microsoft but also lawyers, accountants, consultants and the medical industry accounted for `r toString(format(round(as.numeric(sector_results[[paste0("Services_share_of_jobs_",analysis_years[[1]])]])*100,1),nsmall=0, big.mark=","))`% of all jobs in `r toString(analysis_years[[1]])` and is forecasted to increase its share to `r toString(format(round(as.numeric(sector_results[[paste0("Services_share_of_jobs_",analysis_years[[2]])]])*100,1),nsmall=0, big.mark=","))`% by `r toString(analysis_years[[2]])`

```{r region_sectors, echo = FALSE}
region_sector_chart
```

```{r parcel_information, include=FALSE}
# Create a full parcel file with ID's and then add relevant lookups to it
parcels <- NULL
w_lk <- NULL
parcels <- create_table_from_input("inputs",parcel_file,"csv")

for (lookups in parcel_lookups) {
  w_lk <- create_table_from_input("inputs",lookups[[2]],"csv")
  parcels <- merge(parcels, w_lk, by = "parcel_id")
}

# Recode the TOD ID's for consistency between the Linear and Network Buffers
if (network_buffer == "yes") {
  parcels$tod_id[parcels$tod_id == 0 ] <- 100
  parcels$tod_id[parcels$tod_id == 4 ] <- 101
  parcels$tod_id[parcels$tod_id == 2 ] <- 102
  parcels$tod_id[parcels$tod_id == 5 ] <- 103
  parcels$tod_id[parcels$tod_id == 1 ] <- 104
  parcels$tod_id[parcels$tod_id == 6 ] <- 105
  
} else {
  parcels$tod_id[parcels$tod_id == 0 ] <- 100
  parcels$tod_id[parcels$tod_id == 1 | parcels$tod_id == 2 ] <- 101
  parcels$tod_id[parcels$tod_id == 3 | parcels$tod_id == 4 ] <- 102
  parcels$tod_id[parcels$tod_id == 5 | parcels$tod_id == 6] <- 103
  parcels$tod_id[parcels$tod_id == 7 | parcels$tod_id == 8 ] <- 104
  parcels$tod_id[parcels$tod_id == 9 ] <- 105
}
  
# Update TOD Flag to capture Local Transit
parcels$tod_id[parcels$tod_id == 100 & parcels$transit_buffer_id == 1] <- 106

# Add HCT ID Field
parcel_lookups <- append(parcel_lookups,list(list("hct_id",tod_file,hct_types,hct_names,hct_order,"High Capacity Transit")))
parcels$hct_id <- 0
parcels$hct_id[parcels$tod_id == 100] <- 0
parcels$hct_id[parcels$tod_id >= 101 & parcels$tod_id <= 105] <- 1
parcels$hct_id[parcels$tod_id == 106] <- 2

# Update the TOD ID for Ferry Terminal Corrections
ferry_upd <- create_table_from_input("inputs",ferry_buffer_upd_file,"csv")
cols <- c("parcel_id","updated_id")
setnames(ferry_upd,cols)
parcels <- merge(parcels,ferry_upd, by = "parcel_id", all = TRUE)

parcels$tod_id[parcels$updated_id == 101 ] <- 101
parcels$tod_id[parcels$updated_id == 103 ] <- 103
parcels$hct_id[!is.na(parcels$ferry_id)] <- 1

parcels$rgc_tod_id[parcels$updated_id == 101 & parcels$rgc_tod_id != 105 ] <- 101
parcels$rgc_tod_id[parcels$updated_id == 103 & parcels$rgc_tod_id != 105 ] <- 103

# Add Cities to get Regional Geographies
w_lk <- create_table_from_input("inputs","city","csv")
parcels <- merge(parcels, w_lk, by = "parcel_id")

w_lk <- create_table_from_input("inputs",regional_geo,"csv") 
cols <- c("city_id",rgeo_id)
w_lk <- w_lk[,..cols]
parcels <- merge(parcels, w_lk, by = "city_id")

# Add Regional Geography Field to Lookups
parcel_lookups <- append(parcel_lookups,list(list(rgeo_id,tod_file,rgeo_types,rgeo_names,rgeo_order,"Regional Geographies")))

# Add Housing and Job Capacity to Parcel data.table
w_tbl <- NULL
cols <- c("parcel_id",hh_cap_col,job_cap_col)

w_tbl <- create_table_from_input("inputs",cap_file,"csv")
w_tbl <-w_tbl[,..cols]
upd_nms <- c("parcel_id","hh_capacity","job_capacity")
setnames(w_tbl,upd_nms)
w_tbl <- w_tbl[,(upd_nms):= lapply(.SD, as.integer), .SDcols = upd_nms]

# Convert HH Capacity to Population Capacity using the Regional Average Household Size
w_tbl$pop_capacity <- as.integer(w_tbl$hh_capacity * hh_size)
w_tbl <- w_tbl[,hh_capacity:=NULL]

# Join the capacity and Geometry Flags
parcels <- merge(parcels, w_tbl, by = "parcel_id")

# Add Population and Employment to Parcel data.table
wrk_measures <- c("population","employment","residential_units")

for (w_years in analysis_years) {
  w_tbl <- NULL
  w_tbl <- read.table(paste0(parcel_file_path,"parcel__dataset_table__households_jobs__",w_years,".tab"),sep = '\t',header = TRUE)
  setDT(w_tbl)
  cols <- c("parcel_id",wrk_measures)
  w_tbl <- w_tbl[,..cols]
  w_tbl <- w_tbl[,(cols):= lapply(.SD, as.integer), .SDcols = cols]
  upd_nms <- c("parcel_id",paste0("population_",w_years),paste0("employment_",w_years),paste0("housing_units_",w_years))
  setnames(w_tbl,upd_nms)

  # Join with TOD Flags
  parcels <- merge(parcels, w_tbl, by = "parcel_id")
}

# Output parcel file to csv for creation of shepfiles for automated mapping
w_fname <- paste0(getwd(),'/inputs/parcel_lokups.csv')
fwrite(parcels, w_fname)
```

```{r create_lookup_shapefiles, include = FALSE, eval = create_geo_map}

# Run python code that processes data for import to elmer
source_python("geography-to-parcels.py")
create_geography_files()

```

```{r soundcast_output, include=FALSE}

sc_tbl <- NULL
sc_outputs <- NULL

# Get the Model Base Year Transit Boardings, VMT and Service Hours
vmt_obs <- table_from_db(server_name,database_name,"Craig.regional_hpms_vmt")
setDT(vmt_obs)
hpms_vmt_base <- as.integer(vmt_obs[`year` %in% travel_model_base_year & geography %in% "Region" & category %in% "daily vehicle miles traveled",sum(value)])

# Calculate Boardings and Hours by Urban Area to join with MSA Population via the Urban Area to MSA IDs
urban_areas <- NULL

transit <- table_from_db(server_name,database_name,"Craig.ntd_monthly_transit_data")
setDT(transit)

for (vars in transit_variables) {
  wrk_tbl <- transit[attribute %in% vars]

  # Get Base Year Data and remove Demand Response data
  wrk_tbl <- wrk_tbl[year(date) %in% travel_model_base_year]
  wrk_tbl <- wrk_tbl[modes != "DR" | modes != "DT" | modes != "MO" | modes != "MG" | modes != "VP"]
  wrk_tbl[is.na(wrk_tbl)] <- 0
  col_keep <- c("uza_code","value")
  wrk_tbl <- wrk_tbl[,..col_keep]
  nms <- c("uza_id",vars)
  setnames(wrk_tbl,nms)

  # Aggregate UZA and join with UZA/MSA table
  wrk_uza <- aggregate(wrk_tbl, by=list(wrk_tbl$uza_id),FUN=sum)
  setDT(wrk_uza)
  nms <- c("uza_id","uza_2",vars)
  setnames(wrk_uza,nms)
  fcols <- c("uza_id",vars)
  wrk_uza <- wrk_uza[,..fcols]
  
  if (is.null(urban_areas)) {urban_areas <- wrk_uza} else {urban_areas <- merge(urban_areas, wrk_uza, by = "uza_id")}

}

ntd_boardings_base <- as.integer(urban_areas[`uza_id` %in% psrc_uza,sum(UPT)])
ntd_hours_base <- as.integer(urban_areas[`uza_id` %in% psrc_uza,sum(VRH)])

# First Pull Out Base Year Data 
w_fname <- paste0(getwd(),"/inputs/",soundcast,".xlsx")
sc_outputs <- read_excel(w_fname,sheet = "DSEIS-Base-2014")
setDT(sc_outputs)
  
annual_boardings <- ntd_boardings_base
base_model_boardings <- as.integer(sc_outputs[`Data Item` %in% "Daily Transit Boardings" & Geography %in% "Regional" & Grouping %in% "Total",sum(Value)])
base_model_vmt <- (as.integer(sc_outputs[`Data Item` %in% "Daily VMT" & Geography %in% "Regional" & Grouping %in% "Total",sum(Value)]))

# Now Calculate the Scenario Results
  
# Open the Travel Model Outputs 
w_fname <- paste0(getwd(),"/inputs/",soundcast,".xlsx")
sc_outputs <- read_excel(w_fname,sheet = wrk_scenario)
setDT(sc_outputs)
  
daily_model_boardings <- as.integer(sc_outputs[`Data Item` %in% "Daily Transit Boardings" & Geography %in% "Regional" & Grouping %in% "Total",sum(Value)])
delta_boardings <- (daily_model_boardings - base_model_boardings) * annualization
annual_boardings <-  ntd_boardings_base + delta_boardings

daily_model_vmt <- (as.integer(sc_outputs[`Data Item` %in% "Daily VMT" & Geography %in% "Regional" & Grouping %in% "Total",sum(Value)]))
delta_daily_vmt <- (daily_model_vmt - base_model_vmt)
daily_vmt <- hpms_vmt_base + delta_daily_vmt
  
daily_walk_trips <- as.integer(sc_outputs[`Data Item` %in% "All Trip Totals" & Geography %in% "Regional" & Grouping %in% "Walk",sum(Value)])
daily_bike_trips <- as.integer(sc_outputs[`Data Item` %in% "All Trip Totals" & Geography %in% "Regional" & Grouping %in% "Bike",sum(Value)])
daily_transit_trips <- as.integer(sc_outputs[`Data Item` %in% "All Trip Totals" & Geography %in% "Regional" & Grouping %in% "Transit",sum(Value)])
daily_sov_trips <- as.integer(sc_outputs[`Data Item` %in% "All Trip Totals" & Geography %in% "Regional" & Grouping %in% "SOV",sum(Value)])
daily_hov2_trips <- as.integer(sc_outputs[`Data Item` %in% "All Trip Totals" & Geography %in% "Regional" & Grouping %in% "HOV2",sum(Value)])
daily_hov3_trips <- as.integer(sc_outputs[`Data Item` %in% "All Trip Totals" & Geography %in% "Regional" & Grouping %in% "HOV3+",sum(Value)])

daily_non_vehicle_trips <- daily_transit_trips + daily_walk_trips + daily_bike_trips
daily_non_sov_trips <- daily_non_vehicle_trips + daily_hov2_trips + daily_hov3_trips

daily_co2 <- as.integer(sc_outputs[`Data Item` %in% "Daily CO2 Equivalent Emissions" & Geography %in% "Regional" & Grouping %in% "Total",sum(Value)])
  
daily_vmt_capita <- daily_vmt / horizon_pop
annual_vmt_capita <- (daily_vmt*annualization) / horizon_pop
boardings_capita <- annual_boardings / horizon_pop

boardings_2050 <- annual_boardings
vmt_2050 <- daily_vmt

```

```{r msa_comparion, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# SQL Database Connection settings
elmer_connection <- dbConnect(odbc::odbc(),
  driver = "SQL Server",
  server = "AWS-PROD-SQL\\COHO",
  database = "Sandbox",
  trusted_connection = "yes"
  )

# Urban Area and UZA lookup file
to_open <- paste0(getwd(),"/inputs/uza_ua_codes.csv")
msa <- read.csv(to_open)
setDT(msa)
setnames(msa,c("ua_id","uza_id","uza_name","msa_id","msa_name"))
uza_msa <- msa[,c("uza_id","msa_id")]

# Table Name from the Central Database
ntd_data <- "Craig.ntd_monthly_transit_data"
msa_data <- "Craig.national_msa_population"
fips_codes <- "Craig.fips_codes"
ua_pop <- "Craig.national_urban_area_population"

# Load the Tables from the database and then close the connection
transit <- dbReadTable(elmer_connection,SQL(ntd_data))
population <- dbReadTable(elmer_connection,SQL(msa_data))
fips <- dbReadTable(elmer_connection,SQL(fips_codes))
ua <- dbReadTable(elmer_connection,SQL(ua_pop))

odbc::dbDisconnect(elmer_connection)

# Ensure all are of data.table types
setDT(transit)
setDT(population)
setDT(fips)
setDT(ua)

# Get Job Data 
jobs <- create_table_from_input("inputs",msa_jobs,"csv")
setDT(jobs)
nms <- c("geoid","geo_name","jobs")
setnames(jobs,nms)

# Get VMT Data 
vmt <- create_table_from_input("inputs",uza_vmt,"csv")
setDT(vmt)
nms <- c("geoid","uza_id","name","year","attribute","DVMT")
setnames(vmt,nms)

# Consolidate based on base year and remove columns
vmt <- vmt[year %in% analysis_years[[1]] & attribute %in% c("total daily vehicle miles traveled")]
col_keep <- c("geoid","name","DVMT")
vmt <- vmt[,..col_keep]

# Clean Urban Area population to join with VMT Data
ua <- ua[year %in% analysis_years[[1]]]
ua <- ua[,geoid:=as.integer(geoid)]
col_keep <- c("geoid","value")
ua <- ua[,..col_keep]
nms <- c("geoid","ua_pop")
setnames(ua,nms)

# Add Urban Area Population to VMT Data
vmt <- merge(vmt, ua, by = "geoid")

# Get UA to MSA Definition and join to VMT Data
ua_to_msa <- create_table_from_input("inputs",uza_ua_codes,"csv")
setDT(ua_to_msa)
nms <- c("geoid","uza_id","uza_name","msa_id","msa_name")
setnames(ua_to_msa,nms)
col_keep <- c("geoid","msa_id","msa_name")
ua_to_msa <- ua_to_msa[,..col_keep]
vmt <- merge(vmt, ua_to_msa, by = "geoid")

# Trim down VMT data by MSA with Seattle and Bremerton Combined
col_keep <- c("msa_id","DVMT","ua_pop")
vmt <- vmt[,..col_keep]
vmt$msa_id[vmt$msa_id == 14740] <- 42660

# Combine VMT data by MSA ID
vmt_msa <- aggregate(vmt, by=list(vmt$msa_id),FUN=sum)
setDT(vmt_msa)
nms <- c("msa_id","msa_2","DVMT","ua_pop")
setnames(vmt_msa,nms)

# Calculate VMT per Capita based on UA Population
vmt_msa$VMT_per_Capita <- vmt_msa$DVMT / vmt_msa$ua_pop
col_keep <- c("msa_id","VMT_per_Capita")
vmt_msa <- vmt_msa[,..col_keep]

# Calculate Boardings and Hours by Urban Area to join with MSA Population via the Urban Area to MSA IDs
urban_areas <- NULL

for (vars in transit_variables) {
  wrk_tbl <- transit[attribute %in% vars]

  # Get Base Year Data and remove Demand Response data
  wrk_tbl <- wrk_tbl[year(date) %in% analysis_years[[1]]]
  wrk_tbl <- wrk_tbl[modes != "DR" | modes != "DT"]
  wrk_tbl[is.na(wrk_tbl)] <- 0
  col_keep <- c("uza_code","value")
  wrk_tbl <- wrk_tbl[,..col_keep]
  nms <- c("uza_id",vars)
  setnames(wrk_tbl,nms)

  # Aggregate UZA and join with UZA/MSA table
  wrk_uza <- aggregate(wrk_tbl, by=list(wrk_tbl$uza_id),FUN=sum)
  setDT(wrk_uza)
  nms <- c("uza_id","uza_2",vars)
  setnames(wrk_uza,nms)
  fcols <- c("uza_id",vars)
  wrk_uza <- wrk_uza[,..fcols]
  
  if (is.null(urban_areas)) {urban_areas <- wrk_uza} else {urban_areas <- merge(urban_areas, wrk_uza, by = "uza_id")}

}

# Add MSA ID to Transit Table based on UZA to MSA Lookup and aggregate Bremerton and Seattle MSA
urban_areas <- merge(urban_areas, uza_msa, by = "uza_id")
fcols <- c("msa_id",transit_variables)
urban_areas <- urban_areas[,..fcols]
urban_areas$msa_id[urban_areas$msa_id == 14740] <- 42660

# Combine Transit data by MSA ID
msa_results <- aggregate(urban_areas, by=list(urban_areas$msa_id),FUN=sum)
setDT(msa_results)
nms <- c("msa_id","msa_2",transit_variables)
setnames(msa_results,nms)
col_keep <- c("msa_id",transit_variables)
msa_results <- msa_results[,..col_keep]

#Add VMT per Capita to the Transit results by MSA
msa_results <- merge(msa_results, vmt_msa, by = "msa_id")

# Trim down final MSA transit and VMT table
fcols <- c("msa_id",transit_variables,"VMT_per_Capita")
msa_results <- msa_results[,..fcols]

# Connect MSA Results with MSA Names
fips <- fips[category %in% area_type]
fips <- fips[,c("geoid","name")]
fips <- fips[,geoid:=as.integer(geoid)]
msa_results <- merge(msa_results, fips, by.x = "msa_id",by.y="geoid")

# Connect Base Year Population to the Summary Results
population <- population[year %in% analysis_years[[1]]]
population <- population[,geoid:=as.integer(geoid)]
fcols <- c("geoid","value")
population <- population[,..fcols]
nms <- c("geoid","population")
setnames(population,nms)

# Combine Seattle and Bremerton MSA
population$geoid[population$geoid == 14740] <- 42660
population_msa <- aggregate(population, by=list(population$geoid),FUN=sum)
setDT(population_msa)
nms <- c("geoid","geoid_2","population")
setnames(population_msa,nms)
fcols <- c("geoid","population")
population_msa <- population_msa[,..fcols]

msa_results <- merge(msa_results, population_msa, by.x = "msa_id",by.y="geoid")

# Connect Base Year Jobs to the Summary Results
fcols <- c("geoid","jobs")
jobs <- jobs[,..fcols]

jobs$geoid[jobs$geoid == 14740] <- 42660
jobs_msa <- aggregate(jobs, by=list(jobs$geoid),FUN=sum)
setDT(jobs_msa)
nms <- c("geoid","geoid_2","jobs")
setnames(jobs_msa,nms)
fcols <- c("geoid","jobs")
jobs_msa <- jobs_msa[,..fcols]

msa_results <- merge(msa_results, jobs_msa, by.x = "msa_id",by.y="geoid")

# Clean Up MSA Table
cnames <- c("msa_id","Boardings","Service_Hours","VMT_per_Capita","name","Population","Jobs")
setnames(msa_results,cnames)
msa_results$Boardings_per_Capita <- msa_results$Boardings / msa_results$Population
msa_results$Boardings_per_Hour <- msa_results$Boardings / msa_results$Service_Hours

# Trim down the comparison to places with more than 1m people in the Base Year
msa_results <- msa_results[Population >= pop_threshold]

# Create Puget Sound Region for 2050 and join to Urban Area Comparison
v2050 <- as.data.table(list(msa_id=99998, Population=horizon_pop, Jobs=horizon_jobs, Boardings=boardings_2050, Service_Hours=hours_2050, VMT_per_Capita=vmt_2050/horizon_pop, name="Puget Sound Region 2050",Boardings_per_Capita=boardings_2050/horizon_pop,Boardings_per_Hour=boardings_2050/hours_2050))
msa_results <- rbind(msa_results,v2050)

# Create a plot ID column for cleaner bar charts
msa_results$plot_id <- 0
msa_results$plot_id[msa_results$msa_id == 42660] <- 1
msa_results$plot_id[msa_results$msa_id == 99998] <- 2
msa_results$plot_id[msa_results$msa_id %in% sister_msa] <- 3

# Flatten Urban Area Table
msa_tbl <- melt(msa_results, id.vars=c('msa_id','name',"plot_id"))

# Create Bar Charts
pop_chart <- create_bar_charts(msa_tbl,"Population")
job_chart <- create_bar_charts(msa_tbl,"Jobs")
boardings_chart <- create_bar_charts(msa_tbl,"Boardings")
boardings_per_capita_chart <- create_bar_charts(msa_tbl,"Boardings_per_Capita")
boardings_per_hour_chart <- create_bar_charts(msa_tbl,"Boardings_per_Hour")
vmt_per_capita_chart <- create_bar_charts(msa_tbl,"VMT_per_Capita")

# Calulate Rankings by MSA
pop_rank_today <- calculate_rank(msa_tbl,"Population",42660)
pop_rank_future <- calculate_rank(msa_tbl,"Population",99998)

job_rank_today <- calculate_rank(msa_tbl,"Jobs",42660)
job_rank_future <- calculate_rank(msa_tbl,"Jobs",99998)

vmt_rank_today <- calculate_rank(msa_tbl,"VMT_per_Capita",42660)
vmt_rank_future <- calculate_rank(msa_tbl,"VMT_per_Capita",99998)

boardings_rank_today <- calculate_rank(msa_tbl,"Boardings",42660)
boardings_rank_future <- calculate_rank(msa_tbl,"Boardings",99998)

boardings_capita_rank_today <- calculate_rank(msa_tbl,"Boardings_per_Capita",42660)
boardings_capita_rank_future <- calculate_rank(msa_tbl,"Boardings_per_Capita",99998)

```

```{r scenario_calualtions, include=FALSE}
wrk_measures <- c("population","employment","housing_units")
results_by_type = NULL

# Calculate and store Capacity by Geographic Lookup in a List

# Sumarize Growth by County
for (i in seq(1:5)) {
  
  cnty_id <- county_lookups[[1]][[i]]
  cnty_nm <- county_lookups[[2]][[i]]

  for (lookups in parcel_lookups) {
    w_p <- NULL
    county_parcels <- parcels[county_id %in% cnty_id]

    # Create long list format for calculations
    melt_vars <- c("parcel_id",lookups[[1]])
    meas_vars <- c("pop_capacity","job_capacity")
    w_p <- melt(county_parcels,id.vars = melt_vars, measure.vars = meas_vars)
    w_p$scenario <- "all_scenarios"
    w_p$year <- analysis_years[[1]]

    # Store the capacity results in a list
    for (wrk_att in cap_atttributes) {
      calc_by_tod <- partial(sum_table_values, tbl=w_p, w_col = lookups[[1]], w_scen="all_scenarios", w_var=wrk_att, w_yr=analysis_years[[1]])
      results_by_type[[paste0("all_scenarios_",wrk_att,"_by_",lookups[[1]],"_",cnty_nm)]] <- map(lookups[[3]],calc_by_tod)
      }    
  }
}

# Calculate and store Measures by Geography Type and County
for (i in seq(1:5)) {
  
  cnty_id <- county_lookups[[1]][[i]]
  cnty_nm <- county_lookups[[2]][[i]]

  for (lookups in parcel_lookups) {
  
    for (w_year in analysis_years){
      w_p <- NULL
      county_parcels <- parcels[county_id %in% cnty_id]
  
      # Create long list format for calculations
      melt_vars <- c("parcel_id",lookups[[1]])
      meas_vars <- c(paste0("population_",w_year),paste0("employment_",w_year),paste0("housing_units_",w_year))
      w_p <- melt(county_parcels,id.vars = melt_vars, measure.vars = meas_vars)
      w_p$scenario <- alternatives[[1]][[2]]
      w_p$year <- w_year
  
      # Calculate the Total People and Jobs by Geography Type
      for (lu in lu_atttributes) {
        calc_by_tod <- partial(sum_table_values, tbl=w_p, w_col = lookups[[1]], w_scen=alternatives[[1]][[2]], w_var=paste0(lu,"_",w_year), w_yr=w_year)
        results_by_type[[paste0(alternatives[[1]][[2]],"_",w_year,"_",lu,"_by_",lookups[[1]],"_",cnty_nm)]] <- map(lookups[[3]],calc_by_tod)
      } 
    }
  }
}

# Calculate Regionwide Jobs to Housing Ratios by year
for (w_year in analysis_years){
  results_by_type[[paste0(alternatives[[1]][[2]],"_",w_year,"_regionwide_jhr")]] <- Map('/',  results_by_type[[paste0(alternatives[[1]][[2]],"_",w_year,"_employment_by_county_id_Region")]][[5]], results_by_type[[paste0(alternatives[[1]][[2]],"_",w_year,"_housing_units_by_county_id_Region")]][[5]])
}

# Calculate Jobs to Housing Ratios by year, geography type and county
for (i in seq(1:5)) {
  
  cnty_id <- county_lookups[[1]][[i]]
  cnty_nm <- county_lookups[[2]][[i]]

  for (lookups in parcel_lookups) {
  
    for (w_year in analysis_years){
      results_by_type[[paste0(alternatives[[1]][[2]],"_",w_year,"_jhr_by_",lookups[[1]],"_",cnty_nm)]] <- Map('/',  results_by_type[[paste0(alternatives[[1]][[2]],"_",w_year,"_employment_by_",lookups[[1]],"_",cnty_nm)]], results_by_type[[paste0(alternatives[[1]][[2]],"_",w_year,"_housing_units_by_",lookups[[1]],"_",cnty_nm)]])
      
     results_by_type[[paste0(alternatives[[1]][[2]],"_",w_year,"_jhr_by_",lookups[[1]],"_",cnty_nm)]] <- Map('/', results_by_type[[paste0(alternatives[[1]][[2]],"_",w_year,"_jhr_by_",lookups[[1]],"_",cnty_nm)]],results_by_type[[paste0(alternatives[[1]][[2]],"_",w_year,"_regionwide_jhr")]])
    }
  }
}

# Calculate various differences from the base year by Geography Type and County
for (i in seq(1:5)) {
  
  cnty_id <- county_lookups[[1]][[i]]
  cnty_nm <- county_lookups[[2]][[i]]

  for (lookups in parcel_lookups) {
  
    # Calculate the Total Population Change from the Base Year
    results_by_type[[paste0(alternatives[[1]][[2]],"_pop_change_by_",lookups[[1]],"_",cnty_nm)]] <- Map('-',  results_by_type[[paste0(alternatives[[1]][[2]],"_",analysis_years[[2]],"_",wrk_measures[[1]],"_by_",lookups[[1]],"_",cnty_nm)]], results_by_type[[paste0(alternatives[[1]][[2]],"_",analysis_years[[1]],"_",wrk_measures[[1]],"_by_",lookups[[1]],"_",cnty_nm)]])
  
    # Calculate the Total Job Change from the Base Year
    results_by_type[[paste0(alternatives[[1]][[2]],"_job_change_by_",lookups[[1]],"_",cnty_nm)]] <- Map('-',  results_by_type[[paste0(alternatives[[1]][[2]],"_",analysis_years[[2]],"_",wrk_measures[[2]],"_by_",lookups[[1]],"_",cnty_nm)]], results_by_type[[paste0(alternatives[[1]][[2]],"_",analysis_years[[1]],"_",wrk_measures[[2]],"_by_",lookups[[1]],"_",cnty_nm)]])
    
    # Calculate the Total Job to Housing Ratio change from the Base Year
    results_by_type[[paste0(alternatives[[1]][[2]],"_jhr_change_by_",lookups[[1]],"_",cnty_nm)]] <- Map('-',  results_by_type[[paste0(alternatives[[1]][[2]],"_",analysis_years[[2]],"_jhr_by_",lookups[[1]],"_",cnty_nm)]], results_by_type[[paste0(alternatives[[1]][[2]],"_",analysis_years[[1]],"_jhr_by_",lookups[[1]],"_",cnty_nm)]])

    # Calculate the % Pop Change from the Base Year
    results_by_type[[paste0(alternatives[[1]][[2]],"_percent_pop_change_by_",lookups[[1]],"_",cnty_nm)]] <- Map('/',  results_by_type[[paste0(alternatives[[1]][[2]],"_pop_change_by_",lookups[[1]],"_",cnty_nm)]], results_by_type[[paste0(alternatives[[1]][[2]],"_",analysis_years[[1]],"_",wrk_measures[[1]],"_by_",lookups[[1]],"_",cnty_nm)]])
  
    # Calculate the % Job Change from the Base Year
    results_by_type[[paste0(alternatives[[1]][[2]],"_percent_job_change_by_",lookups[[1]],"_",cnty_nm)]] <- Map('/',  results_by_type[[paste0(alternatives[[1]][[2]],"_job_change_by_",lookups[[1]],"_",cnty_nm)]], results_by_type[[paste0(alternatives[[1]][[2]],"_",analysis_years[[1]],"_",wrk_measures[[2]],"_by_",lookups[[1]],"_",cnty_nm)]])  
    
    # Calculate the % Jobs to Housing Ratio Change from the Base Year
    results_by_type[[paste0(alternatives[[1]][[2]],"_percent_jhr_change_by_",lookups[[1]],"_",cnty_nm)]] <- Map('/',  results_by_type[[paste0(alternatives[[1]][[2]],"_jhr_change_by_",lookups[[1]],"_",cnty_nm)]], results_by_type[[paste0(alternatives[[1]][[2]],"_",analysis_years[[1]],"_jhr_by_",lookups[[1]],"_",cnty_nm)]])
    
    # Calculate the Share of the Total Change from the Base Year
    total_hh_pop_chg <- last(unlist(results_by_type[[paste0(alternatives[[1]][[2]],"_pop_change_by_",lookups[[1]],"_",cnty_nm)]]))
    total_hh_job_chg <- last(unlist(results_by_type[[paste0(alternatives[[1]][[2]],"_job_change_by_",lookups[[1]],"_",cnty_nm)]]))
  
    results_by_type[[paste0(alternatives[[1]][[2]],"_share_pop_change_by_",lookups[[1]],"_",cnty_nm)]] <- Map('/',  results_by_type[[paste0(alternatives[[1]][[2]],"_pop_change_by_",lookups[[1]],"_",cnty_nm)]], total_hh_pop_chg)
  
    results_by_type[[paste0(alternatives[[1]][[2]],"_share_job_change_by_",lookups[[1]],"_",cnty_nm)]] <- Map('/',  results_by_type[[paste0(alternatives[[1]][[2]],"_job_change_by_",lookups[[1]],"_",cnty_nm)]], total_hh_job_chg)  
  
    # Calculate the Remaining Capacity
    results_by_type[[paste0(alternatives[[1]][[2]],"_remain_pop_capacity_by_",lookups[[1]],"_",cnty_nm)]] <- Map('-',  results_by_type[[paste0("all_scenarios_pop_capacity_by_",lookups[[1]],"_",cnty_nm)]], results_by_type[[paste0(alternatives[[1]][[2]],"_pop_change_by_",lookups[[1]],"_",cnty_nm)]])
  
    results_by_type[[paste0(alternatives[[1]][[2]],"_remain_job_capacity_by_",lookups[[1]],"_",cnty_nm)]] <- Map('-',  results_by_type[[paste0("all_scenarios_job_capacity_by_",lookups[[1]],"_",cnty_nm)]], results_by_type[[paste0(alternatives[[1]][[2]],"_job_change_by_",lookups[[1]],"_",cnty_nm)]])  

    # Calculate the Share of Capacity Used
    results_by_type[[paste0(alternatives[[1]][[2]],"_percent_pop_cap_by_",lookups[[1]],"_",cnty_nm)]] <- Map('/',  results_by_type[[paste0(alternatives[[1]][[2]],"_pop_change_by_",lookups[[1]],"_",cnty_nm)]], results_by_type[[paste0("all_scenarios_pop_capacity_by_",lookups[[1]],"_",cnty_nm)]])
  
    results_by_type[[paste0(alternatives[[1]][[2]],"_percent_job_cap_by_",lookups[[1]],"_",cnty_nm)]] <- Map('/',  results_by_type[[paste0(alternatives[[1]][[2]],"_job_change_by_",lookups[[1]],"_",cnty_nm)]], results_by_type[[paste0("all_scenarios_job_capacity_by_",lookups[[1]],"_",cnty_nm)]])     

  }
}

```
# Land Use Summary {.tabset .tabset.fade .tabset-pills}
The charts and tables below summarize various UrbanSim outputs by various summary geographies

## County
Of the four counties in the region, King county is forecasted to ...

### Growth {.tabset .tabset.fade .tabset-pills}
By `r toString(analysis_years[[2]])`, xxx.

```{r county-growth-tables, echo = FALSE, include = FALSE, results = 'asis'}
out <- NULL

my_list <- list(5)

for (i in my_list) {
  summary_geo <- county_lookups[[2]][[i]]
  header_names <- county_lookups[[2]][[i]]
  wrk_id <- 'county_id'
  wrk_nms <- county_names
  wrk_ord <- county_order
  r1 <- paste0(alternatives[[1]][[2]],"_2017_population_by_",wrk_id,"_",summary_geo)
  r2 <- paste0(alternatives[[1]][[2]],"_2050_population_by_",wrk_id,"_",summary_geo)
  r3 <- paste0(alternatives[[1]][[2]],"_pop_change_by_",wrk_id,"_",summary_geo)
  r4 <- paste0(alternatives[[1]][[2]],"_percent_pop_change_by_",wrk_id,"_",summary_geo)
  r5 <- paste0(alternatives[[1]][[2]],"_2017_employment_by_",wrk_id,"_",summary_geo)
  r6 <- paste0(alternatives[[1]][[2]],"_2050_employment_by_",wrk_id,"_",summary_geo)
  r7 <- paste0(alternatives[[1]][[2]],"_job_change_by_",wrk_id,"_",summary_geo)
  r8 <- paste0(alternatives[[1]][[2]],"_percent_job_change_by_",wrk_id,"_",summary_geo)
  r9 <- paste0(alternatives[[1]][[2]],"_2017_jhr_by_",wrk_id,"_",summary_geo)
  r10 <- paste0(alternatives[[1]][[2]],"_2050_jhr_by_",wrk_id,"_",summary_geo)
  r11 <- paste0(alternatives[[1]][[2]],"_jhr_change_by_",wrk_id,"_",summary_geo)
  r12 <- paste0(alternatives[[1]][[2]],"_percent_jhr_change_by_",wrk_id,"_",summary_geo)
  summary_columns <- c("2017","2050","Absolute Change","% Change")
  summary_attributes <- c("People","Jobs","Jobs-Housing Ratio")
  out <- c(out, knitr::knit_child("tables-pie-by-type-child.Rmd"))
}

```

`r paste(out, collapse="\n")`

#### Map
```{r county-area-map-setup, include=FALSE, eval = plot_geo_map}
area_directory <- 'c:/coding/vision-output/inputs/shapefiles/areas'
areas_to_map <- list(list(psrc_colors[["King"]],'county_id_king',"King"),list(psrc_colors[["Kitsap"]],'county_id_kitsap',"Kitsap"),list(psrc_colors[["Pierce"]],'county_id_pierce',"Pierce"),list(psrc_colors[["Snohomish"]],'county_id_snohomish',"Snohomish"))
working_map <- create_area_map(areas_to_map,area_directory)
```

```{r, echo=FALSE, results="asis", eval = plot_geo_map}
working_map
```

### Capacity {.tabset .tabset.fade .tabset-pills}
The table below illustrates the existing zoned capacity for people and jobs by county and how much of that capcity would be utilized if the growth between `r toString(analysis_years[[1]])` and `r toString(analysis_years[[2]])` occurred as analyzed in this scenario.

```{r county-capacity-growth-tables, echo = FALSE, include = FALSE, results = 'asis'}
out <- NULL

my_list <- list(5)

for (i in my_list) {
  summary_geo <- county_lookups[[2]][[i]]
  header_names <- county_lookups[[2]][[i]]
  wrk_id <- 'county_id'
  wrk_nms <- county_names
  wrk_ord <- county_order
  r1 <- paste0("all_scenarios_pop_capacity_by_",wrk_id,"_",summary_geo)
  r2 <- paste0(alternatives[[1]][[2]],"_pop_change_by_",wrk_id,"_",summary_geo)
  r3 <- paste0(alternatives[[1]][[2]],"_remain_pop_capacity_by_",wrk_id,"_",summary_geo)
  r4 <- paste0(alternatives[[1]][[2]],"_percent_pop_cap_by_",wrk_id,"_",summary_geo)
  r5 <- paste0("all_scenarios_job_capacity_by_",wrk_id,"_",summary_geo)
  r6 <- paste0(alternatives[[1]][[2]],"_job_change_by_",wrk_id,"_",summary_geo)
  r7 <- paste0(alternatives[[1]][[2]],"_remain_job_capacity_by_",wrk_id,"_",summary_geo)
  r8 <- paste0(alternatives[[1]][[2]],"_percent_job_cap_by_",wrk_id,"_",summary_geo)
  summary_columns <- c("Existing Capacity","Growth","Remaining Capacity","Percent Capacity Used")
  summary_attributes <- c("People","Jobs")
  out <- c(out, knitr::knit_child("tables-by-type-child.Rmd"))
}
```

`r paste(out, collapse="\n")`

## Large Area
...

### Growth {.tabset .tabset.fade .tabset-pills}
By `r toString(analysis_years[[2]])`, xxx.

```{r la-growth-tables, echo = FALSE, include = FALSE, results = 'asis'}
out <- NULL

my_list <- list(5)

for (i in my_list) {
  summary_geo <- county_lookups[[2]][[i]]
  header_names <- county_lookups[[2]][[i]]
  wrk_id <- la_id
  wrk_nms <- la_names
  wrk_ord <- la_order
  r1 <- paste0(alternatives[[1]][[2]],"_2017_population_by_",wrk_id,"_",summary_geo)
  r2 <- paste0(alternatives[[1]][[2]],"_2050_population_by_",wrk_id,"_",summary_geo)
  r3 <- paste0(alternatives[[1]][[2]],"_pop_change_by_",wrk_id,"_",summary_geo)
  r4 <- paste0(alternatives[[1]][[2]],"_percent_pop_change_by_",wrk_id,"_",summary_geo)
  r5 <- paste0(alternatives[[1]][[2]],"_2017_employment_by_",wrk_id,"_",summary_geo)
  r6 <- paste0(alternatives[[1]][[2]],"_2050_employment_by_",wrk_id,"_",summary_geo)
  r7 <- paste0(alternatives[[1]][[2]],"_job_change_by_",wrk_id,"_",summary_geo)
  r8 <- paste0(alternatives[[1]][[2]],"_percent_job_change_by_",wrk_id,"_",summary_geo)
  r9 <- paste0(alternatives[[1]][[2]],"_2017_jhr_by_",wrk_id,"_",summary_geo)
  r10 <- paste0(alternatives[[1]][[2]],"_2050_jhr_by_",wrk_id,"_",summary_geo)
  r11 <- paste0(alternatives[[1]][[2]],"_jhr_change_by_",wrk_id,"_",summary_geo)
  r12 <- paste0(alternatives[[1]][[2]],"_percent_jhr_change_by_",wrk_id,"_",summary_geo)
  summary_columns <- c("2017","2050","Absolute Change","% Change")
  summary_attributes <- c("People","Jobs","Jobs-Housing Ratio")
  out <- c(out, knitr::knit_child("tables-pie-by-type-child.Rmd"))
}

```

`r paste(out, collapse="\n")`

#### Map

```{r la-area-map-setup, include=FALSE, eval = plot_geo_map}
area_directory <- 'c:/coding/vision-output/inputs/shapefiles/areas'
areas_to_map <- list(list(psrc_colors[["NW Snohomish"]],'large_area_id_nw_snohomish',"NW Snohomish"),list(psrc_colors[["Everett"]],'large_area_id_everett',"Everett"),list(psrc_colors[["SW Snohomish"]],'large_area_id_sw_snohomish',"SW Snohomish"),list(psrc_colors[["Snohomish Other"]],'large_area_id_snohomish_other',"Snohomish Other"), list(psrc_colors[["Shoreline"]],'large_area_id_shoreline',"Shoreline"),list(psrc_colors[["Seattle"]],'large_area_id_seattle',"Seattle"),list(psrc_colors[["Eastside King"]],'large_area_id_eastside_king',"Eastside King"),list(psrc_colors[["SW King"]],'large_area_id_sw_king',"SW King"),list(psrc_colors[["Green River"]],'large_area_id_green_river',"Green River"), list(psrc_colors[["SE King"]],'large_area_id_se_king',"SE King"),list(psrc_colors[["King Other"]],'large_area_id_king_other',"King Other"),list(psrc_colors[["Tacoma"]],'large_area_id_tacoma',"Tacoma"),list(psrc_colors[["SW Pierce"]],'large_area_id_sw_pierce',"SW Pierce"),list(psrc_colors[["Pierce Other"]],'large_area_id_pierce_other',"Pierce Other"), list(psrc_colors[["Peninsula"]],'large_area_id_peninsula',"Peninsula"),list(psrc_colors[["South Kitsap"]],'large_area_id_south_kitsap',"South Kitsap"),list(psrc_colors[["Central Kitsap"]],'large_area_id_central_kitsap',"Central Kitsap"),list(psrc_colors[["North Kitsap"]],'large_area_id_north_kitsap',"North Kitsap"))
working_map <- create_area_map(areas_to_map,area_directory)
```

```{r, echo=FALSE, results="asis", eval = plot_geo_map}
working_map
```

### Capacity {.tabset .tabset.fade .tabset-pills}
The table below illustrates the existing zoned capacity for people and jobs by large area types and how much of that capcity would be utilized if the growth between `r toString(analysis_years[[1]])` and `r toString(analysis_years[[2]])` occurred as analyzed in this scenario.

```{r la-capacity-growth-tables, echo = FALSE, include = FALSE, results = 'asis'}
out <- NULL

my_list <- list(5)

for (i in my_list) {
  summary_geo <- county_lookups[[2]][[i]]
  header_names <- county_lookups[[2]][[i]]
  wrk_id <- la_id
  wrk_nms <- la_names
  wrk_ord <- la_order
  r1 <- paste0("all_scenarios_pop_capacity_by_",wrk_id,"_",summary_geo)
  r2 <- paste0(alternatives[[1]][[2]],"_pop_change_by_",wrk_id,"_",summary_geo)
  r3 <- paste0(alternatives[[1]][[2]],"_remain_pop_capacity_by_",wrk_id,"_",summary_geo)
  r4 <- paste0(alternatives[[1]][[2]],"_percent_pop_cap_by_",wrk_id,"_",summary_geo)
  r5 <- paste0("all_scenarios_job_capacity_by_",wrk_id,"_",summary_geo)
  r6 <- paste0(alternatives[[1]][[2]],"_job_change_by_",wrk_id,"_",summary_geo)
  r7 <- paste0(alternatives[[1]][[2]],"_remain_job_capacity_by_",wrk_id,"_",summary_geo)
  r8 <- paste0(alternatives[[1]][[2]],"_percent_job_cap_by_",wrk_id,"_",summary_geo)
  summary_columns <- c("Existing Capacity","Growth","Remaining Capacity","Percent Capacity Used")
  summary_attributes <- c("People","Jobs")
  out <- c(out, knitr::knit_child("tables-by-type-child.Rmd"))
}
```

`r paste(out, collapse="\n")`

## TOD Area
...

### Growth {.tabset .tabset.fade .tabset-pills}
By `r toString(analysis_years[[2]])`, more than 100 light rail and streetcar stations are planned in the region. In addition, every county has plans for bus rapid transit and several are planning for commuter rail and passenger-only ferry service expansion. The planning for this integrated regional transit network has been on-going and the latest blueprint for it was adopted in the Regional Transportation Plan (RTP) update in 2018. The table below illustrates the population and employment growth for the `r toString(scenario_names)` scenario summarized in this document by county and proximity to type of transit.

```{r ta-growth-tables, echo = FALSE, include = FALSE, results = 'asis'}
out <- NULL

my_list <- list(1,2,3,4,5)

for (i in my_list) {
  summary_geo <- county_lookups[[2]][[i]]
  header_names <- county_lookups[[2]][[i]]
  wrk_id <- 'tod_id'
  wrk_nms <- tod_names
  wrk_ord <- tod_order
  r1 <- paste0(alternatives[[1]][[2]],"_2017_population_by_",wrk_id,"_",summary_geo)
  r2 <- paste0(alternatives[[1]][[2]],"_2050_population_by_",wrk_id,"_",summary_geo)
  r3 <- paste0(alternatives[[1]][[2]],"_pop_change_by_",wrk_id,"_",summary_geo)
  r4 <- paste0(alternatives[[1]][[2]],"_percent_pop_change_by_",wrk_id,"_",summary_geo)
  r5 <- paste0(alternatives[[1]][[2]],"_2017_employment_by_",wrk_id,"_",summary_geo)
  r6 <- paste0(alternatives[[1]][[2]],"_2050_employment_by_",wrk_id,"_",summary_geo)
  r7 <- paste0(alternatives[[1]][[2]],"_job_change_by_",wrk_id,"_",summary_geo)
  r8 <- paste0(alternatives[[1]][[2]],"_percent_job_change_by_",wrk_id,"_",summary_geo)
  r9 <- paste0(alternatives[[1]][[2]],"_2017_jhr_by_",wrk_id,"_",summary_geo)
  r10 <- paste0(alternatives[[1]][[2]],"_2050_jhr_by_",wrk_id,"_",summary_geo)
  r11 <- paste0(alternatives[[1]][[2]],"_jhr_change_by_",wrk_id,"_",summary_geo)
  r12 <- paste0(alternatives[[1]][[2]],"_percent_jhr_change_by_",wrk_id,"_",summary_geo)
  summary_columns <- c("2017","2050","Absolute Change","% Change")
  summary_attributes <- c("People","Jobs","Jobs-Housing Ratio")
  out <- c(out, knitr::knit_child("tables-pie-by-type-child.Rmd"))
}

```

`r paste(out, collapse="\n")`

#### Map

```{r ta-map-setup, include=FALSE, eval = plot_geo_map}
area_directory <- 'c:/coding/vision-output/inputs/shapefiles/areas'
areas_to_map <- list(list(psrc_colors[["Light Rail"]],'tod_id_lrt',"Light Rail"),list(psrc_colors[["Commuter Rail"]],'tod_id_crt',"Commuter Rail"),list(psrc_colors[["Ferry"]],'tod_id_ferry',"Ferry"),list(psrc_colors[["Bus Rapid Transit"]],'tod_id_brt',"Bus Rapid Transit"), list(psrc_colors[["Regional Growth Centers"]],'tod_id_rgc',"Regional Growth Centers"))
working_map <- create_area_map(areas_to_map,area_directory)
```

```{r, echo=FALSE, results="asis", eval = plot_geo_map}
working_map
```

### Capacity {.tabset .tabset.fade .tabset-pills}
The table below illustrates the existing zoned capacity for people and jobs around the various transit area types and how much of that capcity would be utilized if the growth between `r toString(analysis_years[[1]])` and `r toString(analysis_years[[2]])` occurred as analyzed in this scenario.

```{r ta-capacity-growth-tables, echo = FALSE, include = FALSE, results = 'asis'}
out <- NULL

my_list <- list(1,2,3,4,5)

for (i in my_list) {
  summary_geo <- county_lookups[[2]][[i]]
  header_names <- county_lookups[[2]][[i]]
  wrk_id <- 'tod_id'
  wrk_nms <- tod_names
  wrk_ord <- tod_order
  r1 <- paste0("all_scenarios_pop_capacity_by_",wrk_id,"_",summary_geo)
  r2 <- paste0(alternatives[[1]][[2]],"_pop_change_by_",wrk_id,"_",summary_geo)
  r3 <- paste0(alternatives[[1]][[2]],"_remain_pop_capacity_by_",wrk_id,"_",summary_geo)
  r4 <- paste0(alternatives[[1]][[2]],"_percent_pop_cap_by_",wrk_id,"_",summary_geo)
  r5 <- paste0("all_scenarios_job_capacity_by_",wrk_id,"_",summary_geo)
  r6 <- paste0(alternatives[[1]][[2]],"_job_change_by_",wrk_id,"_",summary_geo)
  r7 <- paste0(alternatives[[1]][[2]],"_remain_job_capacity_by_",wrk_id,"_",summary_geo)
  r8 <- paste0(alternatives[[1]][[2]],"_percent_job_cap_by_",wrk_id,"_",summary_geo)
  summary_columns <- c("Existing Capacity","Growth","Remaining Capacity","Percent Capacity Used")
  summary_attributes <- c("People","Jobs")
  out <- c(out, knitr::knit_child("tables-by-type-child.Rmd"))
}
```

`r paste(out, collapse="\n")`

## RGC TOD Area
...

### Growth {.tabset .tabset.fade .tabset-pills}
By `r toString(analysis_years[[2]])`, more than 100 light rail and streetcar stations are planned in the region. In addition, every county has plans for bus rapid transit and several are planning for commuter rail and passenger-only ferry service expansion. The planning for this integrated regional transit network has been on-going and the latest blueprint for it was adopted in the Regional Transportation Plan (RTP) update in 2018. The table below illustrates the population and employment growth for the `r toString(scenario_names)` scenario summarized in this document by county and proximity to type of transit.

```{r rgc-ta-growth-tables, echo = FALSE, include = FALSE, results = 'asis'}
out <- NULL

my_list <- list(1,2,3,4,5)

for (i in my_list) {
  summary_geo <- county_lookups[[2]][[i]]
  header_names <- county_lookups[[2]][[i]]
  wrk_id <- 'rgc_tod_id'
  wrk_nms <- rgc_tod_names
  wrk_ord <- rgc_tod_order
  r1 <- paste0(alternatives[[1]][[2]],"_2017_population_by_",wrk_id,"_",summary_geo)
  r2 <- paste0(alternatives[[1]][[2]],"_2050_population_by_",wrk_id,"_",summary_geo)
  r3 <- paste0(alternatives[[1]][[2]],"_pop_change_by_",wrk_id,"_",summary_geo)
  r4 <- paste0(alternatives[[1]][[2]],"_percent_pop_change_by_",wrk_id,"_",summary_geo)
  r5 <- paste0(alternatives[[1]][[2]],"_2017_employment_by_",wrk_id,"_",summary_geo)
  r6 <- paste0(alternatives[[1]][[2]],"_2050_employment_by_",wrk_id,"_",summary_geo)
  r7 <- paste0(alternatives[[1]][[2]],"_job_change_by_",wrk_id,"_",summary_geo)
  r8 <- paste0(alternatives[[1]][[2]],"_percent_job_change_by_",wrk_id,"_",summary_geo)
  r9 <- paste0(alternatives[[1]][[2]],"_2017_jhr_by_",wrk_id,"_",summary_geo)
  r10 <- paste0(alternatives[[1]][[2]],"_2050_jhr_by_",wrk_id,"_",summary_geo)
  r11 <- paste0(alternatives[[1]][[2]],"_jhr_change_by_",wrk_id,"_",summary_geo)
  r12 <- paste0(alternatives[[1]][[2]],"_percent_jhr_change_by_",wrk_id,"_",summary_geo)
  summary_columns <- c("2017","2050","Absolute Change","% Change")
  summary_attributes <- c("People","Jobs","Jobs-Housing Ratio")
  out <- c(out, knitr::knit_child("tables-pie-by-type-child.Rmd"))
}

```

`r paste(out, collapse="\n")`

#### Map

```{r rgc-ta-map-setup, include=FALSE, eval = plot_geo_map}
area_directory <- 'c:/coding/vision-output/inputs/shapefiles/areas'
areas_to_map <- list(list(psrc_colors[["Light Rail"]],'rgc_tod_id_lrt',"Light Rail"),list(psrc_colors[["Commuter Rail"]],'rgc_tod_id_crt',"Commuter Rail"),list(psrc_colors[["Ferry"]],'rgc_tod_id_ferry',"Ferry"),list(psrc_colors[["Bus Rapid Transit"]],'rgc_tod_id_brt',"Bus Rapid Transit"), list(psrc_colors[["Regional Growth Centers"]],'rgc_tod_id_rgc',"Regional Growth Centers"))
working_map <- create_area_map(areas_to_map,area_directory)
```

```{r, echo=FALSE, results="asis", eval = plot_geo_map}
working_map
```

### Capacity {.tabset .tabset.fade .tabset-pills}
The table below illustrates the existing zoned capacity for people and jobs around the various transit area types and how much of that capcity would be utilized if the growth between `r toString(analysis_years[[1]])` and `r toString(analysis_years[[2]])` occurred as analyzed in this scenario.

```{r rgc-ta-capacity-growth-tables, echo = FALSE, include = FALSE, results = 'asis'}
out <- NULL

my_list <- list(1,2,3,4,5)

for (i in my_list) {
  summary_geo <- county_lookups[[2]][[i]]
  header_names <- county_lookups[[2]][[i]]
  wrk_id <- 'rgc_tod_id'
  wrk_nms <- rgc_tod_names
  wrk_ord <- rgc_tod_order
  r1 <- paste0("all_scenarios_pop_capacity_by_",wrk_id,"_",summary_geo)
  r2 <- paste0(alternatives[[1]][[2]],"_pop_change_by_",wrk_id,"_",summary_geo)
  r3 <- paste0(alternatives[[1]][[2]],"_remain_pop_capacity_by_",wrk_id,"_",summary_geo)
  r4 <- paste0(alternatives[[1]][[2]],"_percent_pop_cap_by_",wrk_id,"_",summary_geo)
  r5 <- paste0("all_scenarios_job_capacity_by_",wrk_id,"_",summary_geo)
  r6 <- paste0(alternatives[[1]][[2]],"_job_change_by_",wrk_id,"_",summary_geo)
  r7 <- paste0(alternatives[[1]][[2]],"_remain_job_capacity_by_",wrk_id,"_",summary_geo)
  r8 <- paste0(alternatives[[1]][[2]],"_percent_job_cap_by_",wrk_id,"_",summary_geo)
  summary_columns <- c("Existing Capacity","Growth","Remaining Capacity","Percent Capacity Used")
  summary_attributes <- c("People","Jobs")
  out <- c(out, knitr::knit_child("tables-by-type-child.Rmd"))
}
```

`r paste(out, collapse="\n")`

## HCT
...

### Growth {.tabset .tabset.fade .tabset-pills}
`r toString(scenario_names)` scenario, placed xx percent of the population growth and xx of the employment growth near high capacity transit. 

```{r county-hct-tables, echo = FALSE, include = FALSE, results = 'asis'}
out <- NULL

my_list <- list(1,2,3,4,5)

for (i in my_list) {
  summary_geo <- county_lookups[[2]][[i]]
  header_names <- county_lookups[[2]][[i]]
  wrk_id <- 'hct_id'
  wrk_nms <- hct_names
  wrk_ord <- hct_order
  r1 <- paste0(alternatives[[1]][[2]],"_2017_population_by_",wrk_id,"_",summary_geo)
  r2 <- paste0(alternatives[[1]][[2]],"_2050_population_by_",wrk_id,"_",summary_geo)
  r3 <- paste0(alternatives[[1]][[2]],"_pop_change_by_",wrk_id,"_",summary_geo)
  r4 <- paste0(alternatives[[1]][[2]],"_percent_pop_change_by_",wrk_id,"_",summary_geo)
  r5 <- paste0(alternatives[[1]][[2]],"_2017_employment_by_",wrk_id,"_",summary_geo)
  r6 <- paste0(alternatives[[1]][[2]],"_2050_employment_by_",wrk_id,"_",summary_geo)
  r7 <- paste0(alternatives[[1]][[2]],"_job_change_by_",wrk_id,"_",summary_geo)
  r8 <- paste0(alternatives[[1]][[2]],"_percent_job_change_by_",wrk_id,"_",summary_geo)
  r9 <- paste0(alternatives[[1]][[2]],"_2017_jhr_by_",wrk_id,"_",summary_geo)
  r10 <- paste0(alternatives[[1]][[2]],"_2050_jhr_by_",wrk_id,"_",summary_geo)
  r11 <- paste0(alternatives[[1]][[2]],"_jhr_change_by_",wrk_id,"_",summary_geo)
  r12 <- paste0(alternatives[[1]][[2]],"_percent_jhr_change_by_",wrk_id,"_",summary_geo)
  summary_columns <- c("2017","2050","Absolute Change","% Change")
  summary_attributes <- c("People","Jobs","Jobs-Housing Ratio")
  out <- c(out, knitr::knit_child("tables-pie-by-type-child.Rmd"))
}
```

`r paste(out, collapse="\n")`

#### Map

```{r hct-area-map-setup, include=FALSE, eval = plot_geo_map}
area_directory <- 'c:/coding/vision-output/inputs/shapefiles/areas'
areas_to_map <- list(list(psrc_colors[["High Capacity Transit"]],'hct_id_hct',"High Capacity Transit"))
working_map <- create_area_map(areas_to_map,area_directory)
```

```{r, echo=FALSE, results="asis", eval = plot_geo_map}
working_map
```

### Capacity {.tabset .tabset.fade .tabset-pills}
The table below illustrates the existing zoned capacity for people and jobs around high capacity transit and how much of that capcity would be utilized if the growth between `r toString(analysis_years[[1]])` and `r toString(analysis_years[[2]])` occurred as analyzed in this scenario.

```{r county-capacity-hct-tables, echo = FALSE, include = FALSE, results = 'asis'}
out <- NULL

my_list <- list(1,2,3,4,5)

for (i in my_list) {
  summary_geo <- county_lookups[[2]][[i]]
  header_names <- county_lookups[[2]][[i]]
  wrk_id <- 'hct_id'
  wrk_nms <- hct_names
  wrk_ord <- hct_order
  r1 <- paste0("all_scenarios_pop_capacity_by_",wrk_id,"_",summary_geo)
  r2 <- paste0(alternatives[[1]][[2]],"_pop_change_by_",wrk_id,"_",summary_geo)
  r3 <- paste0(alternatives[[1]][[2]],"_remain_pop_capacity_by_",wrk_id,"_",summary_geo)
  r4 <- paste0(alternatives[[1]][[2]],"_percent_pop_cap_by_",wrk_id,"_",summary_geo)
  r5 <- paste0("all_scenarios_job_capacity_by_",wrk_id,"_",summary_geo)
  r6 <- paste0(alternatives[[1]][[2]],"_job_change_by_",wrk_id,"_",summary_geo)
  r7 <- paste0(alternatives[[1]][[2]],"_remain_job_capacity_by_",wrk_id,"_",summary_geo)
  r8 <- paste0(alternatives[[1]][[2]],"_percent_job_cap_by_",wrk_id,"_",summary_geo)
  summary_columns <- c("Existing Capacity","Growth","Remaining Capacity","Percent Capacity Used")
  summary_attributes <- c("People","Jobs")
  out <- c(out, knitr::knit_child("tables-by-type-child.Rmd"))
}
```

`r paste(out, collapse="\n")`

## Regional Geography
...

### Growth {.tabset .tabset.fade .tabset-pills}
By `r toString(analysis_years[[2]])`, xxx.

```{r rgeo-growth-tables, echo = FALSE, include = FALSE, results = 'asis'}
out <- NULL

my_list <- list(1,2,3,4,5)

for (i in my_list) {
  summary_geo <- county_lookups[[2]][[i]]
  header_names <- county_lookups[[2]][[i]]
  wrk_id <- rgeo_id
  wrk_nms <- rgeo_names
  wrk_ord <- rgeo_order
  r1 <- paste0(alternatives[[1]][[2]],"_2017_population_by_",wrk_id,"_",summary_geo)
  r2 <- paste0(alternatives[[1]][[2]],"_2050_population_by_",wrk_id,"_",summary_geo)
  r3 <- paste0(alternatives[[1]][[2]],"_pop_change_by_",wrk_id,"_",summary_geo)
  r4 <- paste0(alternatives[[1]][[2]],"_percent_pop_change_by_",wrk_id,"_",summary_geo)
  r5 <- paste0(alternatives[[1]][[2]],"_2017_employment_by_",wrk_id,"_",summary_geo)
  r6 <- paste0(alternatives[[1]][[2]],"_2050_employment_by_",wrk_id,"_",summary_geo)
  r7 <- paste0(alternatives[[1]][[2]],"_job_change_by_",wrk_id,"_",summary_geo)
  r8 <- paste0(alternatives[[1]][[2]],"_percent_job_change_by_",wrk_id,"_",summary_geo)
  r9 <- paste0(alternatives[[1]][[2]],"_2017_jhr_by_",wrk_id,"_",summary_geo)
  r10 <- paste0(alternatives[[1]][[2]],"_2050_jhr_by_",wrk_id,"_",summary_geo)
  r11 <- paste0(alternatives[[1]][[2]],"_jhr_change_by_",wrk_id,"_",summary_geo)
  r12 <- paste0(alternatives[[1]][[2]],"_percent_jhr_change_by_",wrk_id,"_",summary_geo)
  summary_columns <- c("2017","2050","Absolute Change","% Change")
  summary_attributes <- c("People","Jobs","Jobs-Housing Ratio")
  out <- c(out, knitr::knit_child("tables-pie-by-type-child.Rmd"))
}

```

`r paste(out, collapse="\n")`

#### Map

```{r regeo-area-map-setup, include=FALSE, eval = plot_geo_map}
area_directory <- 'c:/coding/vision-output/inputs/shapefiles/areas'
areas_to_map <- list(list(psrc_colors[["Metro"]],'rgeo_id_metro',"Metro Cities"),list(psrc_colors[["Core"]],'rgeo_id_core',"Core Cities"),list(psrc_colors[["HCT"]],'rgeo_id_hct',"High Capacity Transit Cities"),list(psrc_colors[["Cities & Towns"]],'rgeo_id_cities',"Cities & Towns"), list(psrc_colors[["Urban Unincorporated"]],'rgeo_id_uu',"Urban Unincorporated"))
working_map <- create_area_map(areas_to_map,area_directory)
```

```{r, echo=FALSE, results="asis", eval = plot_geo_map}
working_map
```

### Capacity {.tabset .tabset.fade .tabset-pills}
The table below illustrates the existing zoned capacity for people and jobs around the various regional geographies and how much of that capcity would be utilized if the growth between `r toString(analysis_years[[1]])` and `r toString(analysis_years[[2]])` occurred as analyzed in this scenario.

```{r rgeo-capacity-growth-tables, echo = FALSE, include = FALSE, results = 'asis'}
out <- NULL

my_list <- list(1,2,3,4,5)

for (i in my_list) {
  summary_geo <- county_lookups[[2]][[i]]
  header_names <- county_lookups[[2]][[i]]
  wrk_id <- rgeo_id
  wrk_nms <- rgeo_names
  wrk_ord <- rgeo_order
  r1 <- paste0("all_scenarios_pop_capacity_by_",wrk_id,"_",summary_geo)
  r2 <- paste0(alternatives[[1]][[2]],"_pop_change_by_",wrk_id,"_",summary_geo)
  r3 <- paste0(alternatives[[1]][[2]],"_remain_pop_capacity_by_",wrk_id,"_",summary_geo)
  r4 <- paste0(alternatives[[1]][[2]],"_percent_pop_cap_by_",wrk_id,"_",summary_geo)
  r5 <- paste0("all_scenarios_job_capacity_by_",wrk_id,"_",summary_geo)
  r6 <- paste0(alternatives[[1]][[2]],"_job_change_by_",wrk_id,"_",summary_geo)
  r7 <- paste0(alternatives[[1]][[2]],"_remain_job_capacity_by_",wrk_id,"_",summary_geo)
  r8 <- paste0(alternatives[[1]][[2]],"_percent_job_cap_by_",wrk_id,"_",summary_geo)
  summary_columns <- c("Existing Capacity","Growth","Remaining Capacity","Percent Capacity Used")
  summary_attributes <- c("People","Jobs")
  out <- c(out, knitr::knit_child("tables-by-type-child.Rmd"))
}
```

`r paste(out, collapse="\n")`

# Transportation System Metrics {.tabset .tabset.fade .tabset-pills}

## Air Quality {.tabset .tabset.fade .tabset-pills}
xxx
```{r aq, include=FALSE}
out <- NULL

# Travel Model Outputs for Base and Future Year 
base_sc <- setDT(read_excel(paste0(getwd(),"/inputs/",soundcast,".xlsx"),sheet = "DSEIS-Base-2014"))
scen_sc <- setDT(read_excel(paste0(getwd(),"/inputs/",soundcast,".xlsx"),sheet = wrk_scenario))

travel_measures <- list(list("Region","Regional"))
#travel_measures <- list(list("CO2","Daily CO2 Equivalent Emissions"),list("CO","Daily CO Emissions"), list("NOx","Daily NOx Emissions"), list("VOC","Daily VOCs Emissions"), list("PM10","Daily PM 10 Emissions"), list("PM25","Daily PM 2.5 Emissions"))

for (measures in travel_measures) {
  summary_attributes <- c('Air Quality Metrics by Year')
  summary_columns <- c("Today","2050","Delta","% Change")
  w_att <- list('Daily CO2 Equivalent Emissions','Daily CO Emissions', 'Daily NOx Emissions', 'Daily VOCs Emissions', 'Daily PM 10 Emissions', 'Daily PM 2.5 Emissions')
  w_geo <- list("Regional")
  w_grp <- "Total"
  output_type <- "integer"
  out <- c(out, knitr::knit_child("transportation-metrics-child.Rmd"))
}

```

`r paste(out, collapse="\n")`

## Vehicles {.tabset .tabset.fade .tabset-pills}
xxx
```{r vehicle_summaries, include=FALSE}
out <- NULL

travel_measures <- list(list("King","King County"),list("Kitsap","Kitsap County"), list("Pierce","Pierce County"), list("Snohomish","Snohomish County"), list("Region","Regional"))

for (measures in travel_measures) {
  summary_attributes <- c('Vehicle Metrics by Year')
  summary_columns <- c("Today","2050","Delta","% Change")
  w_att <- list('Daily VMT','Daily VHT', 'Daily Delay')
  w_geo <- list(measures[[2]])
  w_grp <- "Total"
  output_type <- "integer"
  out <- c(out, knitr::knit_child("transportation-metrics-child.Rmd"))
}
```

`r paste(out, collapse="\n")`

## Trucks {.tabset .tabset.fade .tabset-pills}
xxx
```{r truck_summaries, include=FALSE}
out <- NULL

travel_measures <- list(list("King","King County"),list("Kitsap","Kitsap County"), list("Pierce","Pierce County"), list("Snohomish","Snohomish County"))

for (measures in travel_measures) {
  summary_attributes <- c('Truck Metrics by Year')
  summary_columns <- c("Today","2050","Delta","% Change")
  w_att <- list('Daily Medium Truck Delay','Daily Heavy Truck Delay')
  w_geo <- list(measures[[2]])
  w_grp <- "Total"
  output_type <- "integer"
  out <- c(out, knitr::knit_child("transportation-metrics-child.Rmd"))
}
```

`r paste(out, collapse="\n")`

# Transit Performance Metrics {.tabset .tabset.fade .tabset-pills}

## Boardings by Operator {.tabset .tabset.fade .tabset-pills}
xxx
```{r boardings-by-op, include=FALSE}
out <- NULL

travel_measures <- list(list("Region","Regional"))

for (measures in travel_measures) {
  summary_attributes <- c(measures[[2]])
  summary_columns <- c("Today","2050","Delta","% Change")
  w_att <- list("Daily Transit Boardings")
  w_geo <- list("Community Transit","Everett Transit","King County Metro", "Kitsap Transit","Pierce Transit","Sound Transit","Washington Ferries","Regional")
  w_grp <- "Total"
  output_type <- "integer"
  out <- c(out, knitr::knit_child("transportation-metrics-child.Rmd"))
}

```

`r paste(out, collapse="\n")`

## Transit Mode Share {.tabset .tabset.fade .tabset-pills}
xxx
```{r comm-trn, include=FALSE}
out <- NULL

travel_measures <- list(list("King","King County"),list("Kitsap","Kitsap County"), list("Pierce","Pierce County"), list("Snohomish","Snohomish County"), list("Region","Regional"))

for (measures in travel_measures) {
  summary_attributes <- c(measures[[2]])
  summary_columns <- c("Today","2050","Delta","% Change")
  w_att <- list("Commute Trip Mode Share","Non-Commute Trip Mode Share")
  w_geo <- list(measures[[2]])
  w_grp <- "Transit"
  output_type <- "percentage"
  out <- c(out, knitr::knit_child("transportation-metrics-child.Rmd"))
}

```

`r paste(out, collapse="\n")`

# Roadway Congestion {.tabset .tabset.fade .tabset-pills}
Roadway congestion is defined by comparing the operating speed on a roadway facility for a specific time period to the posted speed limit. Moderate congestion levels are defined as places where the ratio of the oeprating speed to the posted speed is 50%-70%. Heavy Congestion is defined as locations where the ratio of the operating speed to the posted speed is 25%-50% and Severe congestion is defined as anything less than 25% of the posted speed limit.  

```{r create_congestion_maps, include = FALSE}
fwy_links <- c(1,3)
art_links <- c(5,7)
source_python("soundcast-network.py")

# AM Peak Hour
create_network_shapefiles(soundcast_folder,output_folder,'7to8')
am_freeway <- create_congestion_map('7to8',c(1,3))
am_arterials <- create_congestion_map('7to8',c(5,7))

# Calculate AM Summary Metrics
tod <- '7to8'

model.shape <- readOGR(dsn='c:/coding/vision-output/outputs',layer=paste0('network_shape_',tod))
network_data <- setDT(model.shape@data)
network_data$lane_miles <- network_data$lanes * network_data$len

# Lane Miles at Different Levels of Congestion
am_fwy_tot_lm <- as.integer(network_data[vdf %in% fwy_links,sum(lane_miles)])
am_art_tot_lm <- as.integer(network_data[vdf %in% art_links,sum(lane_miles)])
am_fwy_mod_lm <- as.integer(network_data[vdf %in% fwy_links & spr >= 0.5 & spr < 0.7,sum(lane_miles)])
am_art_mod_lm <- as.integer(network_data[vdf %in% art_links & spr >= 0.5 & spr < 0.7,sum(lane_miles)])
am_fwy_hvy_lm <- as.integer(network_data[vdf %in% fwy_links & spr >= 0.25 & spr < 0.5,sum(lane_miles)])
am_art_hvy_lm <- as.integer(network_data[vdf %in% art_links & spr >= 0.25 & spr < 0.5,sum(lane_miles)])
am_fwy_sev_lm <- as.integer(network_data[vdf %in% fwy_links & spr < 0.25,sum(lane_miles)])
am_art_sev_lm <- as.integer(network_data[vdf %in% art_links & spr < 0.25,sum(lane_miles)])

am_fwy_mod_shr <- am_fwy_mod_lm / am_fwy_tot_lm
am_fwy_hvy_shr <- am_fwy_hvy_lm / am_fwy_tot_lm
am_fwy_sev_shr <- am_fwy_sev_lm / am_fwy_tot_lm
am_fwy_cong <- am_fwy_mod_shr + am_fwy_hvy_shr + am_fwy_sev_shr

am_art_mod_shr <- am_art_mod_lm / am_fwy_tot_lm
am_art_hvy_shr <- am_art_hvy_lm / am_fwy_tot_lm
am_art_sev_shr <- am_art_sev_lm / am_fwy_tot_lm
am_art_cong <- am_art_mod_shr + am_art_hvy_shr + am_art_sev_shr

#PM Peak Hour
create_network_shapefiles(soundcast_folder,output_folder,'17to18')
pm_freeway <- create_congestion_map('17to18',c(1,3))
pm_arterials <- create_congestion_map('17to18',c(5,7))

# Calculate PM Summary Metrics
tod <- '17to18'

model.shape <- readOGR(dsn='c:/coding/vision-output/outputs',layer=paste0('network_shape_',tod))
network_data <- setDT(model.shape@data)
network_data$lane_miles <- network_data$lanes * network_data$len

# Lane Miles at Different Levels of Congestion
pm_fwy_tot_lm <- as.integer(network_data[vdf %in% fwy_links,sum(lane_miles)])
pm_art_tot_lm <- as.integer(network_data[vdf %in% art_links,sum(lane_miles)])
pm_fwy_mod_lm <- as.integer(network_data[vdf %in% fwy_links & spr >= 0.5 & spr < 0.7,sum(lane_miles)])
pm_art_mod_lm <- as.integer(network_data[vdf %in% art_links & spr >= 0.5 & spr < 0.7,sum(lane_miles)])
pm_fwy_hvy_lm <- as.integer(network_data[vdf %in% fwy_links & spr >= 0.25 & spr < 0.5,sum(lane_miles)])
pm_art_hvy_lm <- as.integer(network_data[vdf %in% art_links & spr >= 0.25 & spr < 0.5,sum(lane_miles)])
pm_fwy_sev_lm <- as.integer(network_data[vdf %in% fwy_links & spr < 0.25,sum(lane_miles)])
pm_art_sev_lm <- as.integer(network_data[vdf %in% art_links & spr < 0.25,sum(lane_miles)])

pm_fwy_mod_shr <- pm_fwy_mod_lm / pm_fwy_tot_lm
pm_fwy_hvy_shr <- pm_fwy_hvy_lm / pm_fwy_tot_lm
pm_fwy_sev_shr <- pm_fwy_sev_lm / pm_fwy_tot_lm
pm_fwy_cong <- pm_fwy_mod_shr + pm_fwy_hvy_shr + pm_fwy_sev_shr

pm_art_mod_shr <- pm_art_mod_lm / pm_fwy_tot_lm
pm_art_hvy_shr <- pm_art_hvy_lm / pm_fwy_tot_lm
pm_art_sev_shr <- pm_art_sev_lm / pm_fwy_tot_lm
pm_art_cong <- pm_art_mod_shr + pm_art_hvy_shr + pm_art_sev_shr
```

## AM Freeway
By the year `r toString(analysis_years[[2]])`, `r toString(format(round((am_fwy_sev_shr)*100,0), nsmall=0))`% of the region's freeway lane-miles will be severly congestion (traveling less than 25% of the posted speed limit). In addition, more than `r toString(format(round((am_fwy_hvy_shr)*100,0), nsmall=0))`% of freeway lane miles will be heavily congested (speeds between 25%-50% of speed limit) and another `r toString(format(round((am_fwy_mod_shr)*100,0), nsmall=0))`% lane miles in moderate congestion (50% to 70% of posted speed). In all, over `r toString(format(round((am_fwy_cong)*100,0), nsmall=0))`% of all freeway lane miles in the region will experience some level of congestion.

```{r plot_am_fwy, echo = FALSE}
am_freeway
```

## AM Arterials
By the year `r toString(analysis_years[[2]])`, `r toString(format(round((am_art_sev_shr)*100,0), nsmall=0))`% of the region's arterial lane-miles will be severly congestion (traveling less than 25% of the posted speed limit). In addition, more than `r toString(format(round((am_art_hvy_shr)*100,0), nsmall=0))`% of arterial lane miles will be heavily congested (speeds between 25%-50% of speed limit) and another `r toString(format(round((am_art_mod_shr)*100,0), nsmall=0))`% lane miles in moderate congestion (50% to 70% of posted speed). In all, over `r toString(format(round((am_art_cong)*100,0), nsmall=0))`% of all arterial lane miles in the region will experience some level of congestion.

```{r plot_am_art, echo = FALSE}
am_arterials
```

## PM Freeway
By the year `r toString(analysis_years[[2]])`, `r toString(format(round((pm_fwy_sev_shr)*100,0), nsmall=0))`% of the region's freeway lane-miles will be severly congestion (traveling less than 25% of the posted speed limit). In addition, more than `r toString(format(round((pm_fwy_hvy_shr)*100,0), nsmall=0))`% of freeway lane miles will be heavily congested (speeds between 25%-50% of speed limit) and another `r toString(format(round((pm_fwy_mod_shr)*100,0), nsmall=0))`% lane miles in moderate congestion (50% to 70% of posted speed). In all, over `r toString(format(round((pm_fwy_cong)*100,0), nsmall=0))`% of all freeway lane miles in the region will experience some level of congestion.

```{r plot_pm_fwy, echo = FALSE}
pm_freeway
```

## PM Arterials
By the year `r toString(analysis_years[[2]])`, `r toString(format(round((pm_art_sev_shr)*100,0), nsmall=0))`% of the region's arterial lane-miles will be severly congestion (traveling less than 25% of the posted speed limit). In addition, more than `r toString(format(round((pm_art_hvy_shr)*100,0), nsmall=0))`% of arterial lane miles will be heavily congested (speeds between 25%-50% of speed limit) and another `r toString(format(round((pm_art_mod_shr)*100,0), nsmall=0))`% lane miles in moderate congestion (50% to 70% of posted speed). In all, over `r toString(format(round((pm_art_cong)*100,0), nsmall=0))`% of all arterial lane miles in the region will experience some level of congestion.

```{r plot_pm_art, echo = FALSE}
pm_arterials
```

# Trip Distance
xx

## County {.tabset .tabset.fade .tabset-pills}
xxx
```{r county_trip_length_summaries, include=FALSE}
out <- NULL

travel_measures <- list(list("King","King County"),list("Kitsap","Kitsap County"), list("Pierce","Pierce County"), list("Snohomish","Snohomish County"), list("Region","Regional"))

for (measures in travel_measures) {
  summary_attributes <- c('Average Trip Distance (miles)')
  summary_columns <- c("Today","2050","Delta","% Change")
  w_att <- list('Commute Trip Length','Other Trip Length')
  w_geo <- list(measures[[2]])
  w_grp <- "Total"
  output_type <- "decimal"
  out <- c(out, knitr::knit_child("transportation-metrics-child.Rmd"))
}
```

`r paste(out, collapse="\n")`

## Regional Geography {.tabset .tabset.fade .tabset-pills}
xxx
```{r rgeo_trip_length_summaries, include=FALSE}
out <- NULL

travel_measures <- list(list("Metro","Metropolitan Cities"),list("Core","Core Cities"), list("HCT","HCT Communities"), list("Cities and Towns","Cities and Towns"), list("UU","Urban Unincorporated"), list("Rural","Rural"), list("Region","Regional"))

for (measures in travel_measures) {
  summary_attributes <- c('Average Trip Distance (miles)')
  summary_columns <- c("Today","2050","Delta","% Change")
  w_att <- list('Commute Trip Length','Other Trip Length')
  w_geo <- list(measures[[2]])
  w_grp <- "Total"
  output_type <- "decimal"
  out <- c(out, knitr::knit_child("transportation-metrics-child.Rmd"))
}
```

`r paste(out, collapse="\n")`

## Equity Geography {.tabset .tabset.fade .tabset-pills}
xxx
```{r eq_trip_length_summaries, include=FALSE}
out <- NULL

travel_measures <- list(list("< 50% people of color","50% People of Color and Under"),list("> 50% people of color","Over 50% People of Color"), list("< 50% low income","50% Low Income and Under"), list("> 50% low income","Over 50% Low Income"), list("Region","Regional"))

for (measures in travel_measures) {
  summary_attributes <- c('Average Trip Distance (miles)')
  summary_columns <- c("Today","2050","Delta","% Change")
  w_att <- list('Commute Trip Length','Other Trip Length')
  w_geo <- list(measures[[2]])
  w_grp <- "Total"
  output_type <- "decimal"
  out <- c(out, knitr::knit_child("transportation-metrics-child.Rmd"))
}
```

`r paste(out, collapse="\n")`

# Mode Shares
xx

## County {.tabset .tabset.fade .tabset-pills}
xxx
```{r county_mode_summaries, include=FALSE}
out <- NULL

summary_tabs <- list(list("King","King County"),list("Kitsap","Kitsap County"), list("Pierce","Pierce County"), list("Snohomish","Snohomish County"), list("Region","Regional"))

for (tabs in summary_tabs) {
  summary_attributes <- list('Commute Trip Mode Share','Non-Commute Trip Mode Share','All Trip Mode Share')
  summary_columns <- c("Today","2050","Delta","% Change")
  w_att <- list('Commute Trip Mode Share','Non-Commute Trip Mode Share','All Trip Mode Share')
  w_geo <- list(tabs[[2]])
  w_grp <- list("SOV","HOV2","HOV3+","Transit","School Bus","Walk","Bike")
  output_type <- "percentage"
  out <- c(out, knitr::knit_child("mode-share-child.Rmd"))
}
```

`r paste(out, collapse="\n")`

## Regional Geography {.tabset .tabset.fade .tabset-pills}
xxx
```{r rgeo_mode_summaries, include=FALSE}
out <- NULL

summary_tabs <- list(list("Metro","Metropolitan Cities"),list("Core","Core Cities"), list("HCT","HCT Communities"), list("Cities and Towns","Cities and Towns"), list("UU","Urban Unincorporated"), list("Rural","Rural"), list("Region","Regional"))

for (tabs in summary_tabs) {
  summary_attributes <- list('Commute Trip Mode Share','Non-Commute Trip Mode Share','All Trip Mode Share')
  summary_columns <- c("Today","2050","Delta","% Change")
  w_att <- list('Commute Trip Mode Share','Non-Commute Trip Mode Share','All Trip Mode Share')
  w_geo <- list(tabs[[2]])
  w_grp <- list("SOV","HOV2","HOV3+","Transit","School Bus","Walk","Bike")
  output_type <- "percentage"
  out <- c(out, knitr::knit_child("mode-share-child.Rmd"))
}
```

`r paste(out, collapse="\n")`

## Equity Geography {.tabset .tabset.fade .tabset-pills}
xxx
```{r equity_mode_summaries, include=FALSE}
out <- NULL

summary_tabs <- list(list("< 50% people of color","50% People of Color and Under"),list("> 50% people of color","Over 50% People of Color"), list("< 50% low income","50% Low Income and Under"), list("> 50% low income","Over 50% Low Income"), list("Region","Regional"))

for (tabs in summary_tabs) {
  summary_attributes <- list('Commute Trip Mode Share','Non-Commute Trip Mode Share','All Trip Mode Share')
  summary_columns <- c("Today","2050","Delta","% Change")
  w_att <- list('Commute Trip Mode Share','Non-Commute Trip Mode Share','All Trip Mode Share')
  w_geo <- list(tabs[[2]])
  w_grp <- list("SOV","HOV2","HOV3+","Transit","School Bus","Walk","Bike")
  output_type <- "percentage"
  out <- c(out, knitr::knit_child("mode-share-child.Rmd"))
}
```

`r paste(out, collapse="\n")`

# Comparison to Other Metro Areas {.tabset .tabset.fade .tabset-pills}
MSA's are areas consisting of a core county or counties in which lies an urban area having a population of at least 50,000, plus adjacent counties having a high degree of social and economic integration with the core counties as measured through commuting ties.

## Population
In `r toString(analysis_years[[1]])`, the Central Puget Sound region ranked #`r toString(pop_rank_today)` of 53 Metropolitan Statistical Areas (MSA's) in the United States with a population of at least one million people. Other MSA's with similar populations include San Diego, Minneapolis, Detroit and Tampa Bay. When you compare the `r toString(analysis_years[[2]])` forecast of population for the region, the population rank for the Central Puget Sound region would be #`r toString(pop_rank_future)` of 53 places today with a population more similar to places like Atlanta, Miami, Philadelphia and Washington DC.


```{r plot_pop_charts, echo = FALSE}
pop_chart

```

## Employment
In `r toString(analysis_years[[1]])`, the Central Puget Sound region ranked #`r toString(job_rank_today)` of 53 MSA's for total jobs. Other MSA's with similar numbers of jobs include Detroit, Minneapolis, and Phoenix. When you compare the `r toString(analysis_years[[2]])` forecast of jobs for the region, the rank for the Central Puget Sound region would be #`r toString(job_rank_future)` of 53 places today with job totals more similar to places like Dallas, Houston, Philadelphia and Washington DC.

```{r plot_job_charts, echo = FALSE}
job_chart
```


## VMT per Capita
Miles driven per person have been declining in the Central Puget Sound Region for the past 20 years. VMT per day peaked in the late 1990's around 24 miles driven per person per day and has been fairly steady for the past 10 years at around 21 miles per person per day. Changes in land use and a continued diversification of travel options are key drivers behind a shortening of VMT per person,

In `r toString(analysis_years[[1]])`, the Central Puget Sound region ranked #`r toString(vmt_rank_today)` of 53 MSA's for miles driven per person per day. Other MSA's with similar levels of daily VMT per capita include San Francisco, Chicago, and Tucson. When you compare the `r toString(analysis_years[[2]])` forecast of miles driven for the region, the rank for the Central Puget Sound region would be #`r toString(vmt_rank_future)` of 53 places today with only New York City having fewer miles driven per day.

```{r, plot_vmt_outputs, echo=FALSE}
vmt_per_capita_chart
```

## Transit Boardings
In `r toString(analysis_years[[1]])`, the Central Puget Sound region ranked #`r toString(boardings_rank_today)` of 53 MSA's for transit boardings . Other MSA's with similar levels of Boardings per capita include San Francisco, Chicago, and Tucson. When you compare the `r toString(analysis_years[[2]])` forecast of transit boardings for the region, the rank for the Central Puget Sound region would be #`r toString(boardings_rank_future)` of 53 places today with only New York City having more boardings per day.

```{r, plot_boardings_outputs, echo=FALSE}
boardings_chart
```

## Boardings per Capita
In `r toString(analysis_years[[1]])`, the Central Puget Sound region ranked #`r toString(boardings_capita_rank_today)` of 53 MSA's for boardings per person per year. Other MSA's with similar levels of Boardings per capita include San Francisco, Chicago, and Tucson. When you compare the `r toString(analysis_years[[2]])` forecast of boardings per person for the region, the rank for the Central Puget Sound region would be #`r toString(boardings_capita_rank_future)` of 53 places today with only New York City having more boardings per day.

```{r, plot_boardings_capita_outputs, echo=FALSE}
boardings_per_capita_chart
```

```{r lrt_stations_setup, include=FALSE}

# Clear out temporary data.tables
station_parcels <- NULL
wrk_measures <- c("Population","Employment")

lrt_station_lookup <- create_table_from_input("inputs",lrt_stations,"csv")
wrk_parcels <- merge(parcels, lrt_station_lookup, by = "parcel_id")
wrk_parcels <- wrk_parcels[,c('parcel_id','station_name','population_2017','population_2050','employment_2017','employment_2050')]

# Calculate and store Measures by Geography Type
  
for (w_year in analysis_years){
  w_p <- NULL
  
  # Trim down to only have year of interest data
  orig_cols <- c("parcel_id",'station_name',paste0("population_",w_year),paste0("employment_",w_year))
  w_p <- wrk_parcels[,..orig_cols]
  nms <- c("parcel_id",'station_name','Population','Employment')
  setnames(w_p,nms)
  
  # Create long list format for calculations
  melt_vars <- c("parcel_id",'station_name')
  meas_vars <- c("Population","Employment")
  
  w_p <- melt(w_p,id.vars = melt_vars, measure.vars = meas_vars)
  w_p$scenario <- alternatives[[1]][[1]]
  w_p$year <- w_year
  
  if (is.null(station_parcels)) {station_parcels <- w_p} else {station_parcels <- rbind(station_parcels,w_p)}
}
    
# Create Station Area Summary
station_summary <- station_parcels[,.(results = sum(value)),by=.(station_name,variable,scenario,year)]
station_summary <- station_summary[station_name != ""]

# Calculate the Population and Employment Growth from the Base Year by Scenario
for (files in alternatives) {
  
  base_att <- NULL
  scen_att <- NULL
  scen_delta <- NULL

  for (lu_att in wrk_measures) {
    wrk_scen <- alternatives[[1]][[1]]
    
    # Get Base Year Values by Station Area
    base_att <- station_summary[variable %in% lu_att & scenario %in% wrk_scen & year %in% analysis_years[[1]]]
    base_att <- base_att[,c("station_name","results")]
    setnames(base_att,c("station_name","base_year"))  

    # Get Scenario Values by Station Area
    scen_att <- station_summary[variable %in% lu_att & scenario %in% wrk_scen & year %in% analysis_years[[2]]]
    scen_att <- scen_att[,c("station_name","results")]
    setnames(scen_att,c("station_name","future_year"))

    # Merge and Calculate the difference
    scen_delta <- merge(base_att, scen_att, by = "station_name")
    scen_delta$results <- scen_delta$future_year - scen_delta$base_year
    scen_delta$variable <- paste0(lu_att," Growth")
    scen_delta$scenario <- wrk_scen
    scen_delta$year <- analysis_years[[2]]
    scen_delta <- scen_delta[,c("station_name","variable","scenario","results","year")]

    # Merge and Calculate the percentage difference
    scen_percent <- merge(base_att, scen_att, by = "station_name")
    scen_percent$results <- (scen_percent$future_year - scen_percent$base_year) / scen_percent$base_year
    scen_percent[is.na(scen_percent)] <- 0
    scen_percent$variable <- paste0(lu_att," % Change")
    scen_percent$scenario <- wrk_scen
    scen_percent$year <- analysis_years[[2]]
    scen_percent <- scen_percent[,c("station_name","variable","scenario","results","year")]

    # Merge and Calculate the share ofr the total difference
    scen_share <- merge(base_att, scen_att, by = "station_name")
    total_growth <- as.integer(colSums(scen_share[,'future_year']) - colSums(scen_share[,'base_year']))
    scen_share$results <- (scen_share$future_year - scen_share$base_year) / total_growth
    scen_share[is.na(scen_share)] <- 0
    scen_share$variable <- paste0(lu_att," Share of Change")
    scen_share$scenario <- wrk_scen
    scen_share$year <- analysis_years[[2]]
    scen_share <- scen_share[,c("station_name","variable","scenario","results","year")]
        
    station_summary <- rbind(station_summary,scen_delta)
    station_summary <- rbind(station_summary,scen_percent)
    station_summary <- rbind(station_summary,scen_share)
  }
}  

```

# Light Rail Station Areas {.tabset .tabset.fade .tabset-pills}
By the year `r toString(analysis_years[[2]])`, light rail will connect a majority of Regional Growth Centers with over 100 different stations .  The `r toString(alternatives[[1]][[1]])` scenario directs approximately `r toString(format(round(as.numeric(results_by_type[[paste0(alternatives[[1]][[2]],"_pop_change_by_tod_id_Region")]][[2]]),0), nsmall=0, big.mark=","))` new people within 1/2 mile of these stations (`r toString(format(round(as.numeric(results_by_type[[paste0(alternatives[[1]][[2]],"_share_pop_change_by_tod_id_Region")]][[2]]*100),0), nsmall=0, big.mark=","))`% of total population growth) and `r toString(format(round(as.numeric(results_by_type[[paste0(alternatives[[1]][[2]],"_job_change_by_tod_id_Region")]][[2]]),0), nsmall=0, big.mark=","))` new jobs within 1/2 mile of these stations (`r toString(format(round(as.numeric(results_by_type[[paste0(alternatives[[1]][[2]],"_share_job_change_by_tod_id_Region")]][[2]]*100),0), nsmall=0, big.mark=","))`% of total job growth).

## Total Growth around LRT Stations {.tabset .tabset.fade .tabset-pills}
...

```{r lrt-total-station-plots, echo = FALSE, include = FALSE, results = 'asis'}
out <- NULL
my_list <- list(1,2)
metrics <- c("Population Growth","Employment Growth")
num_typ <- "integer"
num_dig <- 0
bins <- c(0,2000,8000,32000,72000,128000,200000)

for (i in seq_along(my_list)) {
  out <- c(out, knitr::knit_child("maps-by-station-child.Rmd"))
}

```

`r paste(out, collapse="\n")`

## Percent Change around LRT Stations {.tabset .tabset.fade .tabset-pills}
...

```{r lrt-percent-station-plots, echo = FALSE, include = FALSE, results = 'asis'}
out <- NULL
my_list <- list(1,2)
metrics <- c("Population % Change","Employment % Change")
num_typ <- "percentage"
num_dig <- 0
bins <- c(0,25,50,75,100,150,500,1000,2500)

for (i in seq_along(my_list)) {
  out <- c(out, knitr::knit_child("maps-by-station-child.Rmd"))
}

```

`r paste(out, collapse="\n")`

## Share of Growth around LRT Stations {.tabset .tabset.fade .tabset-pills}
...

```{r lrt-share-station-plots, echo = FALSE, include = FALSE, results = 'asis'}
out <- NULL
my_list <- list(1,2)
metrics <- c("Population Share of Change","Employment Share of Change")
num_typ <- "percentage"
num_dig <- 1
bins <- c(0,2,5,10,15,20,25)

for (i in seq_along(my_list)) {
  out <- c(out, knitr::knit_child("maps-by-station-child.Rmd"))
}

```

`r paste(out, collapse="\n")`
